<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Event란건 어쩌면 어려운게 아닐까" /><meta name="author" content="Wongyu Lee" /><meta property="og:locale" content="en" /><meta name="description" content="Kubernetes Architecture" /><meta property="og:description" content="Kubernetes Architecture" /><link rel="canonical" href="https://blog.wqlee.com/posts/what-is-a-kubernetes-watch-event-4rd/" /><meta property="og:url" content="https://blog.wqlee.com/posts/what-is-a-kubernetes-watch-event-4rd/" /><meta property="og:site_name" content="wq.lee" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-01-29T20:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Event란건 어쩌면 어려운게 아닐까" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Wongyu Lee","url":"https://github.com/21kyu"},"dateModified":"2022-04-19T23:00:34+09:00","datePublished":"2022-01-29T20:00:00+09:00","description":"Kubernetes Architecture","headline":"Event란건 어쩌면 어려운게 아닐까","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.wqlee.com/posts/what-is-a-kubernetes-watch-event-4rd/"},"url":"https://blog.wqlee.com/posts/what-is-a-kubernetes-watch-event-4rd/"}</script><title>Event란건 어쩌면 어려운게 아닐까 | wq.lee</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="wq.lee"><meta name="application-name" content="wq.lee"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/avata.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">wq.lee</a></div><div class="site-subtitle font-italic">룰루랄라 즐거웁다 쿠버네티스</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/21kyu" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/wq-lee" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['qoo','kakao.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Event란건 어쩌면 어려운게 아닐까</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Event란건 어쩌면 어려운게 아닐까</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/21kyu">Wongyu Lee</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1643454000" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-01-29 </em> </span> <span> Updated <em class="timeago" data-ts="1650376834" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-04-19 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2595 words"> <em>14 min</em> read</span></div></div></div><div class="post-content"><h2 id="kubernetes-architecture"><span class="mr-2">Kubernetes Architecture</span><a href="#kubernetes-architecture" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Kubernetes는 microservice 기반의 아키텍처가 적용되어 있다. Control Plane, Worker Node의 컴포넌트들은 개별 서비스로 구현된다. 특히 Control Plane은 Event와 함께 느슨하게 결합된 구성 요소의 원칙을 많이 접목시켜 사용하고 있다. 이러한 아키텍처의 주요 이점은 개발 및 배포의 유연성과 독립성, 수평 확장성 및 장애 허용이라고 할 수 있겠다. 즉 etcd, scheduler, api server 등과 같은 중요한 프로세스를 두 개 이상의 인스턴스로 실행한다.</p><p>이러한 개별 서비스들은 Control Loop(관찰 -&gt; 분석 -&gt; 행위)로 모델링되면서 오직 api server와 통신을 한다. 즉, 서로 직접 통신을 하지 않는다.</p><p>이러한 특성 탓에 Kubernetes는 Microservice 간의 흐름이 중앙 조정자없이 구성되는 event-driven architecture라고도 한다.</p><h2 id="what-is-an-event"><span class="mr-2">What is an Event?</span><a href="#what-is-an-event" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>이벤트란건 단순히 일어난 불변의 사실이다. Kubernetes control plane에서 여러 구성 요소들이 API server를 통해 Kubernetes의 개체들을 변경하며, 이러한 변경에 대한 작업은 결국 event로 이어진다.</p><h4 id="producers-andor-consumers"><span class="mr-2">Producers and/or consumers</span><a href="#producers-andor-consumers" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>모든 프로세스(또는 컨트롤러)는 이벤트의 생산하는 producer일 수도 있고, 이벤트를 소비하는 consumer일 수도 있다.</p><p>소비자는 API server에서 이벤트를 수신하려는 개체를 지정한다. 이를 Kubernetes에서는 listWatch라고 한다. 소비자가 관찰을 시작할 때엔 관련된 리소스의 모든 리스트를 나열한 다음 특정 리소스 버전 이후의 이벤트에 대해서만 watch 모드로 전환하여 API server의 부하를 줄이도록 설계가 되어 있다.</p><p>소비자와 생산자는 대기열 등의 구조들에 의해 완전히 분리되어 있으며 서로에 대해 직접적으로 알 필요가 전혀 없다. 이 구조는 전체 시스템을 아주 쉽게 확장 가능하도록 하는 가장 큰 요인이 될 것이다.</p><p>따라서 이벤트가 생산자에서 소비자로 전파되는데 시간이 약간의 걸리기는 할테지만(거의 실시간), 설계 상 완전히 비동기적이고 궁극적으로는 일관된 플랫폼이다.</p><h2 id="kubernetes-core-design-concept"><span class="mr-2">Kubernetes core design concept</span><a href="#kubernetes-core-design-concept" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Event의 상태 변경을 감지하는 2가지 원칙적인 옵션이 존재한다.</p><dl><dt>Edge-driven triggers<dd>상태 변경이 발생하는 시점(e.g., 존재하지 않던 Pod가 실행됨)에 handler가 트리거된다.<dt>Level-driven triggers<dd>상태는 주기적으로 확인되며 특정 조건이 충족(e.g., Pod가 실행 중)되면 handler가 트리거 된다. Polling의 한 형태라고도 할 수 있다.</dl><p>Kubernetes 개체의 변경은 event로 이어진다고 했다. 프로세스(또는 컨트롤러)의 맥락에서 보자면 발생되는 이벤트에 언제 어떻게 반응해야할지, 구현에 대한 고민이 생길 수 있다. Kubernetes에서는 이를 어떻게 해결했는지 크게 두 주제를 살펴보자.</p><h4 id="level-triggering-and-soft-reconciliation"><span class="mr-2">Level Triggering and Soft Reconciliation</span><a href="#level-triggering-and-soft-reconciliation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><ol><li>Edge-driven logic<ul><li>네트워킹이 끊어지면 event가 손실될 수 있고, controller 자체에 버그가 존재하거나 일부 외부 cloud API가 다운되는 경우도 있어서 누락된 event에 대해 잘 대처하지 못한다.<li>replicaSet controller가 pod 조욜 시에만 해당 pod를 교체한다고 가정했을 때, 누락된 event는 전체 상태를 조정하지 않기 때문에 항상 더 적은 수의 pod가 실행될 수 있게 된다.</ul><li>Edge-triggered, level-driven logic<ul><li>cluster의 최신 상태를 기반으로 로직을 구현하기 때문에 다른 이벤트가 수신될 때 1.에서 발생될 수 있는 문제를 복구한다.<li>replicaSet controller의 경우 항상 지정된 replicas를 클러스터에서 실행 중인 pod와 비교하며 event가 손실되더라고 다음 pod update가 수신될 때 누락된 모든 pod를 교체한다.</ul><li>Reconciliation with resync<ul><li>2.에 지속적인 동기화를 추가한다.<li>일반적인 edge-driven trigger의 문제를 감안할 때, kubernetes controller는 3.의 전략으로 돌아간다.</ul></ol><p>컨트롤러는 기본적으로 stateless하다. 이벤트 기반 설계는 이벤트 소싱 개념과 유사하게 컨트롤러가 (재)시작될 때 모든 (적절한) 이벤트를 replay한다. Kubernetes의 컨트롤러는 Edge-Driven Triggers가 아닌 Level-Driven Triggers로 동작하도록 설계되었기 때문에 네트워크 이슈나 컨트롤러 다운타임 동안 이벤트를 놓치게 되면 다음 동기화(Soft Reconciliation)가 있을 때 해당 개체애 대한 완전한 상태를 수신할 수 있게 된다.</p><h4 id="optimistic-concurrency"><span class="mr-2">Optimistic Concurrency</span><a href="#optimistic-concurrency" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p>Etcd에 정보가 저장이 될 때 Kubernetes의 구조 상 동일 정보가 두 번 이상 전달될 수 있고 컨트롤러가 서로 간에 직접 통신하지 않기 때문에 상태가 변경될 때 경쟁 조건이 발생할 가능성이 있다. 낙관적 동시성을 통해 다른 컨트롤러에서도 동일한 개체에 쓰기 작업을 할 경우 충돌이 발생되며 각자 컨트롤러에서 충돌에 대한 후처리를 해야만 한다. Kubernetes는 낙관적 동시성을 단조적으로 증가하는 resourceVersion 기반으로 깔끔하게 구현해뒀다.</p><h2 id="watch-in-etcd"><span class="mr-2">Watch in ETCD</span><a href="#watch-in-etcd" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>etcd는 하나의 key에 대응되는 value 하나만을 저장하고 있는 것이 아니라, key의 모든 변경사항을 파일시스템에 기록하며 이것은 revision을 통해 이루어진다.</p><div class="table-wrapper"><table><thead><tr><th>Key<th>Value<th>Revision<tbody><tr><td>/registry/pods/default/test<td>…test=1…<td>1<tr><td>/registry/pods/default/test<td>…test=5…<td>2<tr><td>/registry/pods/default/test<td>…test=2…<td>3</table></div><p>Etcd는 key에 대한 변경 사항을 비동기적으로 모니터링하기 위한 이벤트 기반 인터페이스는 watch feature를 통해 제공한다. API server 내의 etcd v3 client는 watchGrpcStream을 통해 etcd의 watch feature를 사용하고, etcd에 대한 session을 제공하고 관리한다.</p><p><img data-src="/images/watch-in-etcd.png" alt="watch-in-etcd" data-proofer-ignore> <em>그림 1. Watch in etcd</em></p><p>etcd의 Revision은 곧 Kubernetes에서의 Resource Version이다. etcd3storage의 versioner(<em>APIObjectVersioner</em>)는 etcd로부터 전달받은 객체의 revision 값을 통해 resource version을 설정한다.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="c">// UpdateObject implements Versioner</span>
<span class="k">func</span> <span class="p">(</span><span class="n">a</span> <span class="n">APIObjectVersioner</span><span class="p">)</span> <span class="n">UpdateObject</span><span class="p">(</span><span class="n">obj</span> <span class="n">runtime</span><span class="o">.</span><span class="n">Object</span><span class="p">,</span> <span class="n">resourceVersion</span> <span class="kt">uint64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="n">accessor</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">meta</span><span class="o">.</span><span class="n">Accessor</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">err</span>
  <span class="p">}</span>
  <span class="n">versionString</span> <span class="o">:=</span> <span class="s">""</span>
  <span class="k">if</span> <span class="n">resourceVersion</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">versionString</span> <span class="o">=</span> <span class="n">strconv</span><span class="o">.</span><span class="n">FormatUint</span><span class="p">(</span><span class="n">resourceVersion</span><span class="p">,</span> <span class="m">10</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">accessor</span><span class="o">.</span><span class="n">SetResourceVersion</span><span class="p">(</span><span class="n">versionString</span><span class="p">)</span>
  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="watch-event-in-kubeapiserver"><span class="mr-2">Watch Event in kubeAPIServer</span><a href="#watch-event-in-kubeapiserver" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Kubernetes에서의 Watch Event는 아래와 같은 흐름으로 전달이 된다.</p><div class="table-wrapper"><table><thead><tr><th>etcd watcher<th>-&gt; watch cache<th>-&gt; cacheWatcher(s)<tbody><tr><td>Get events from etcd<td>Implement Store interface<td>Serve events to clients</table></div><p>Cacher와 Etcd storage는 API server가 시작될 때 지원해야할 리소스들의 정보에 따라 API가 셋업되면서 만들어진다. Cacher 내부에 포함된 Reflector에서 호출될 ListAndWatch 메서드에서의 watch 작업은 etcd watcher가 포함된 etcd storage의 watch 메서드를 호출한다.</p><p><img data-src="/images/cacher.png" alt="cacher" data-proofer-ignore> <em>그림 2. Cacher</em></p><p>etcd watcher는 etcd v3 client session을 제공하고 관리하는 Client의 Watch를 통해(여기에서 gRPC를 통해 etcd와 bidirection stream으로 이벤트를 전달받는다.) WatchResponse를 가져와 파싱하고, watchChan.incomingEventChan으로 전달한다.</p><p><img data-src="/images/etct-watcher.png" alt="etcd watcher" data-proofer-ignore> <em>그림 3. Etcd storage</em></p><p>processEvent를 통해 etcd watcher의 이벤트를 incomingEventChan으로 받아 처리하고 그 결과를 resultChan으로 보낸다. 이 결과는 곧 Cacher 내부의 reflector가 수행하는 watch로 전달되어 watchCache가 받아 processEvent를 통해 이벤트를 전달하게 되고 Cacher의 Watchers에 등록되어 있던 모든 cacheWatcher들에게 해당 이벤트를 최종적으로 전달해준다.</p><p>Cacher의 구성요소들을 살펴보는 것을 끝으로 마무리하자.</p><dl><dt>RawStorage<dd>Low level key/value storage이다. 사실 이건 Cacher의 구성요소라기 보다는 리소스에 따라 기본적으로 생성되어야 하는 것이며 watchCache 기능이 필요없는 리소스인 경우에는 <a href="https://pkg.go.dev/k8s.io/apiserver/pkg/registry/generic#UndecoratedStorage">UndecoratedStorage</a> 를 통해 storage가 생성이 될텐데, 이 때에도 RawStorage는 만들어진다. 생성될 때 주어진 구성을 기반으로 ETCD3Storage라는 storage backend가 만들어진다. ETCD3Storage 내부에는 etcd3를 위한 <a href="https://pkg.go.dev/k8s.io/apiserver@v0.23.5/pkg/storage#Interface">storage.Interface</a> 구현체인 Store와 etcd v3 client의 session을 제공하고 관리하는 ETCD3Client가 존재하며 API Server는 etcd에서 제공해주는 watch feature를 사용하기 위해 ETCD3Client를 통해 etcd와 gRPC bidirectional stream 연결을 맺고 key에 대한 변경 사항을 비동기적으로 모니터링한다.<dt>cacheListerWatcher<dd>ListerWatcher는 List() 및 Watch()를 포함하는 인터페이스 객체이다. 먼저 모든 항목을 나열하고 호출 순간의 resource version을 가져온 다음 이를 사용해 watch를 시작한다.<dt>reflector<dd>ListerWatcher를 사용해 Store로부터 전달받은 event(transformer와 versioner를 거쳐옴)를 type에 따라 분류하고 watchCache에 전달한다. Object가 추가되거나 삭제될 때에는 Added/Deleted로 분류되며, Modified는 여러 변경 사항이 결합된 이벤트가 호출될 수 있으므로 이것을 단일 변경 사항에 대한 이벤트라고 볼 순 없다.<dt>watchCache<dd>watchCache는 Store 인터페이스를 구현하며 API Server가 etcd에서 감시하는 객체를 저장하기 위해 사용되는 cache이다.<dt>watchers<dd>watchers(indexedWatchers)는 map이며 map의 value type은 cacheWatcher이다. kubelet, kube-scheduler와 같은 client가 특정 유형의 감시 리소스가 필요할 때 apiServer에 watch 요청을 시작하고, apiServer는 cacheWatcher를 생성한다. cacheWatcher는 watch.Interface의 구현체이며, thread-safe하지 않다. watch resource를 담당하여 http 통신을 통해 API Server에서 client로 전달한다.<dt>watchCacheEvent<dd>watchCache를 사용하는 client에게 보내는 단일 watch event이다. 일반적인 watch.Event에 추가로 upper layers에서 적절한 필터링을 활성화하기 위한 객체의 이전 상태(prevObject)를 포함한다.</dl><div style="text-align: center; font-weight: bold; margin-top: 100px; margin-bottom: 50px">끝.</div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kubernetes/'>kubernetes</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >kubernetes</a> <a href="/tags/watch/" class="post-tag no-text-decoration" >watch</a> <a href="/tags/event/" class="post-tag no-text-decoration" >event</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Event%EB%9E%80%EA%B1%B4+%EC%96%B4%EC%A9%8C%EB%A9%B4+%EC%96%B4%EB%A0%A4%EC%9A%B4%EA%B2%8C+%EC%95%84%EB%8B%90%EA%B9%8C+-+wq.lee&url=https%3A%2F%2Fblog.wqlee.com%2Fposts%2Fwhat-is-a-kubernetes-watch-event-4rd%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Event%EB%9E%80%EA%B1%B4+%EC%96%B4%EC%A9%8C%EB%A9%B4+%EC%96%B4%EB%A0%A4%EC%9A%B4%EA%B2%8C+%EC%95%84%EB%8B%90%EA%B9%8C+-+wq.lee&u=https%3A%2F%2Fblog.wqlee.com%2Fposts%2Fwhat-is-a-kubernetes-watch-event-4rd%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fblog.wqlee.com%2Fposts%2Fwhat-is-a-kubernetes-watch-event-4rd%2F&text=Event%EB%9E%80%EA%B1%B4+%EC%96%B4%EC%A9%8C%EB%A9%B4+%EC%96%B4%EB%A0%A4%EC%9A%B4%EA%B2%8C+%EC%95%84%EB%8B%90%EA%B9%8C+-+wq.lee" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fblog.wqlee.com%2Fposts%2Fwhat-is-a-kubernetes-watch-event-4rd%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/cgroups-and-kubernetes/">Control groups & Kubernetes</a><li><a href="/posts/what-is-a-kubernetes-watch-event-4rd/">Event란건 어쩌면 어려운게 아닐까</a><li><a href="/posts/scheduling-in-go-01/">Scheduling In Go I - OS Scheduler</a><li><a href="/posts/what-is-a-kubernetes-watch-event-3rd/">Informer의 구조</a><li><a href="/posts/what-is-a-kubernetes-watch-event-2nd/">Watch Server에 요청이 도달하기까지의 과정</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/event/">event</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/watch/">watch</a> <a class="post-tag" href="/tags/os/">os</a> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/apiserver/">apiserver</a> <a class="post-tag" href="/tags/go/">go</a> <a class="post-tag" href="/tags/gorestful/">gorestful</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/scheduler/">scheduler</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/basic-etcd/"><div class="card-body"> <em class="timeago small" data-ts="1642600800" > 2022-01-19 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Basic ETCD</h3><div class="text-muted small"><p> Highly Available Fully Replicated Strong consistency model Scalable watch mechanism Concurrency control primitives Distributed Key/Value store Distributed consensus is a fancy way to e...</p></div></div></a></div><div class="card"> <a href="/posts/what-is-a-kubernetes-watch-event-3rd/"><div class="card-body"> <em class="timeago small" data-ts="1641649500" > 2022-01-08 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Informer의 구조</h3><div class="text-muted small"><p> 일전에 정리했던 내용과 같이 클라이언트가 API server에 Watch event를 요청할 때 streaming HTTP connection을 맺어 해당 리소스의 변경에 대한 이벤트를 전달받곤 했다. 이러한 변경 감지가 필요할 때마다 API server에 접근해야하는건 Kubernetes 시스템에 부하를 줄 수도 있다. 게다가 여러 클라이언트, 컨트...</p></div></div></a></div><div class="card"> <a href="/posts/what-is-a-kubernetes-watch-event/"><div class="card-body"> <em class="timeago small" data-ts="1640502000" > 2021-12-26 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Kubernetes의 Watch event는 어떻게 동작하는가</h3><div class="text-muted small"><p> Kubernetes는 pods, deployments, services와 같은 resource들을 모니터링하고 관련 event를 추적할 수 있는 Watch 개념을 가지고 있다. 대부분 이미 Kubernetes의 Watch 기능을 사용해봤을 것이다. 나는 Deployment 등을 배포하고 Pod의 배포 상태를 계속 보고 싶을 때 Kubectl에 -w ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/basic-etcd/" class="btn btn-outline-primary" prompt="Older"><p>Basic ETCD</p></a> <a href="/posts/linux-kernel-networking-01/" class="btn btn-outline-primary" prompt="Newer"><p>Socket Buffer</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://www.linkedin.com/in/wq-lee">Wongyu Lee</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/event/">event</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/watch/">watch</a> <a class="post-tag" href="/tags/os/">os</a> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/apiserver/">apiserver</a> <a class="post-tag" href="/tags/go/">go</a> <a class="post-tag" href="/tags/gorestful/">gorestful</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/scheduler/">scheduler</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-4PS0JXVL1J"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-4PS0JXVL1J'); }); </script>
