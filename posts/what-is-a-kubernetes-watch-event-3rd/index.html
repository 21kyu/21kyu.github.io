<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Informer의 구조" /><meta name="author" content="Wongyu Lee" /><meta property="og:locale" content="en" /><meta name="description" content="일전에 정리했던 내용과 같이 클라이언트가 API server에 Watch event를 요청할 때 streaming HTTP connection을 맺어 해당 리소스의 변경에 대한 이벤트를 전달받곤 했다. 이러한 변경 감지가 필요할 때마다 API server에 접근해야하는건 Kubernetes 시스템에 부하를 줄 수도 있다. 게다가 여러 클라이언트, 컨트롤러에서 Watch event를 요청하게 되면 시스템에 더욱 높은 부하가 생성될 것이다." /><meta property="og:description" content="일전에 정리했던 내용과 같이 클라이언트가 API server에 Watch event를 요청할 때 streaming HTTP connection을 맺어 해당 리소스의 변경에 대한 이벤트를 전달받곤 했다. 이러한 변경 감지가 필요할 때마다 API server에 접근해야하는건 Kubernetes 시스템에 부하를 줄 수도 있다. 게다가 여러 클라이언트, 컨트롤러에서 Watch event를 요청하게 되면 시스템에 더욱 높은 부하가 생성될 것이다." /><link rel="canonical" href="https://blog.wqlee.com/posts/what-is-a-kubernetes-watch-event-3rd/" /><meta property="og:url" content="https://blog.wqlee.com/posts/what-is-a-kubernetes-watch-event-3rd/" /><meta property="og:site_name" content="wq.lee" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-01-08T22:45:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Informer의 구조" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Wongyu Lee","url":"https://github.com/21kyu"},"dateModified":"2022-04-12T14:31:27+09:00","datePublished":"2022-01-08T22:45:00+09:00","description":"일전에 정리했던 내용과 같이 클라이언트가 API server에 Watch event를 요청할 때 streaming HTTP connection을 맺어 해당 리소스의 변경에 대한 이벤트를 전달받곤 했다. 이러한 변경 감지가 필요할 때마다 API server에 접근해야하는건 Kubernetes 시스템에 부하를 줄 수도 있다. 게다가 여러 클라이언트, 컨트롤러에서 Watch event를 요청하게 되면 시스템에 더욱 높은 부하가 생성될 것이다.","headline":"Informer의 구조","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.wqlee.com/posts/what-is-a-kubernetes-watch-event-3rd/"},"url":"https://blog.wqlee.com/posts/what-is-a-kubernetes-watch-event-3rd/"}</script><title>Informer의 구조 | wq.lee</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="wq.lee"><meta name="application-name" content="wq.lee"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/avata.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">wq.lee</a></div><div class="site-subtitle font-italic">룰루랄라 즐거웁다 쿠버네티스</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/21kyu" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/wq-lee" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['qoo','kakao.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Informer의 구조</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Informer의 구조</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/21kyu">Wongyu Lee</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1641649500" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-01-08 </em> </span> <span> Updated <em class="timeago" data-ts="1649741487" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-04-12 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3212 words"> <em>17 min</em> read</span></div></div></div><div class="post-content"><p>일전에 정리했던 내용과 같이 클라이언트가 API server에 Watch event를 요청할 때 streaming HTTP connection을 맺어 해당 리소스의 변경에 대한 이벤트를 전달받곤 했다. 이러한 변경 감지가 필요할 때마다 API server에 접근해야하는건 Kubernetes 시스템에 부하를 줄 수도 있다. 게다가 여러 클라이언트, 컨트롤러에서 Watch event를 요청하게 되면 시스템에 더욱 높은 부하가 생성될 것이다.</p><p>Informer는 In-memory 캐싱을 통해 이러한 문제를 해결하고자 했다. 이번 포스팅에서는 Informer에 대해 정리해보도록 하자.</p><h3 id="prerequisites"><span class="mr-2">Prerequisites</span><a href="#prerequisites" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li><a href="https://go.dev">Go</a><li><a href="https://kubernetes.io/docs/tasks/tools/#kubectl">kubectl</a><li><a href="https://minikube.sigs.k8s.io/docs/">minikube</a></ul><h2 id="first-lets-use-informer"><span class="mr-2">First, let’s use Informer</span><a href="#first-lets-use-informer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Informer에 대해 자세히 파악하기 전에 간단히 사용해보고자 한다. 먼저 minikube를 실행시켜주자.</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>❯ minikube start
😄  minikube v1.24.0 on Darwin 12.2
✨  Automatically selected the docker driver. Other choices: hyperkit, parallels, ssh
👍  Starting control plane node minikube <span class="k">in </span>cluster minikube
🚜  Pulling base image ...
💾  Downloading Kubernetes v1.22.3 preload ...
    <span class="o">&gt;</span> preloaded-images-k8s-v13-v1...: 501.73 MiB / 501.73 MiB  100.00% 55.37 Mi
    <span class="o">&gt;</span> gcr.io/k8s-minikube/kicbase: 355.78 MiB / 355.78 MiB  100.00% 14.47 MiB p
🔥  Creating docker container <span class="o">(</span><span class="nv">CPUs</span><span class="o">=</span>2, <span class="nv">Memory</span><span class="o">=</span>1985MB<span class="o">)</span> ...
🐳  Preparing Kubernetes v1.22.3 on Docker 20.10.8 ...
    ▪ Generating certificates and keys ...
    ▪ Booting up control plane ...
    ▪ Configuring RBAC rules ...
🔎  Verifying Kubernetes components...
    ▪ Using image gcr.io/k8s-minikube/storage-provisioner:v5
🌟  Enabled addons: storage-provisioner, default-storageclass
🏄  Done! kubectl is now configured to use <span class="s2">"minikube"</span> cluster and <span class="s2">"default"</span> namespace by default
</pre></table></code></div></div><p>Informer 예제를 작성하기 위한 Go 프로젝트를 하나 만들어준다.</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>❯ go mod init example.com/informer
go: creating new go.mod: module example.com/informer

❯ <span class="nb">touch </span>main.go
</pre></table></code></div></div><p><strong>main.go</strong> 파일 생성 후 아래 코드를 작성하도록 하자.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre><td class="rouge-code"><pre><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"fmt"</span>
  <span class="s">"os"</span>
  <span class="s">"time"</span>

  <span class="n">v1</span> <span class="s">"k8s.io/api/core/v1"</span>
  <span class="s">"k8s.io/client-go/informers"</span>
  <span class="s">"k8s.io/client-go/kubernetes"</span>
  <span class="s">"k8s.io/client-go/tools/cache"</span>
  <span class="s">"k8s.io/client-go/tools/clientcmd"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">kubeconfigPath</span> <span class="o">:=</span> <span class="s">"location to your kubeconfig file path"</span>
  <span class="n">config</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">clientcmd</span><span class="o">.</span><span class="n">BuildConfigFromFlags</span><span class="p">(</span><span class="s">""</span><span class="p">,</span> <span class="n">kubeconfigPath</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"The kubeconfig can't be loaded: %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
    <span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">clientset</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">NewForConfig</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"NewForConfig failed: %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
    <span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">stopCh</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="k">struct</span><span class="p">{})</span>
  <span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="n">stopCh</span><span class="p">)</span>

  <span class="n">informerFactory</span> <span class="o">:=</span> <span class="n">informers</span><span class="o">.</span><span class="n">NewSharedInformerFactory</span><span class="p">(</span><span class="n">clientset</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="o">*</span><span class="m">1</span><span class="p">)</span>

  <span class="n">podInformer</span> <span class="o">:=</span> <span class="n">informerFactory</span><span class="o">.</span><span class="n">Core</span><span class="p">()</span><span class="o">.</span><span class="n">V1</span><span class="p">()</span><span class="o">.</span><span class="n">Pods</span><span class="p">()</span>
  <span class="n">podInformer</span><span class="o">.</span><span class="n">Informer</span><span class="p">()</span><span class="o">.</span><span class="n">AddEventHandler</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">ResourceEventHandlerFuncs</span><span class="p">{</span>
    <span class="n">AddFunc</span><span class="o">:</span> <span class="k">func</span><span class="p">(</span><span class="n">obj</span> <span class="k">interface</span><span class="p">{})</span> <span class="p">{</span>
      <span class="n">pod</span> <span class="o">:=</span> <span class="n">obj</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">v1</span><span class="o">.</span><span class="n">Pod</span><span class="p">)</span>
      <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Add: "</span> <span class="o">+</span> <span class="n">pod</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="n">UpdateFunc</span><span class="o">:</span> <span class="k">func</span><span class="p">(</span><span class="n">oldObj</span><span class="p">,</span> <span class="n">newObj</span> <span class="k">interface</span><span class="p">{})</span> <span class="p">{</span>
      <span class="n">pod</span> <span class="o">:=</span> <span class="n">newObj</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">v1</span><span class="o">.</span><span class="n">Pod</span><span class="p">)</span>
      <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Update: "</span> <span class="o">+</span> <span class="n">pod</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="n">DeleteFunc</span><span class="o">:</span> <span class="k">func</span><span class="p">(</span><span class="n">obj</span> <span class="k">interface</span><span class="p">{})</span> <span class="p">{</span>
      <span class="n">pod</span> <span class="o">:=</span> <span class="n">obj</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">v1</span><span class="o">.</span><span class="n">Pod</span><span class="p">)</span>
      <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Delete: "</span> <span class="o">+</span> <span class="n">pod</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
    <span class="p">},</span>
  <span class="p">})</span>

  <span class="n">informerFactory</span><span class="o">.</span><span class="n">Start</span><span class="p">(</span><span class="n">stopCh</span><span class="p">)</span>
  <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"InformerFactory started"</span><span class="p">)</span>

  <span class="o">&lt;-</span><span class="n">stopCh</span>
<span class="p">}</span>
</pre></table></code></div></div><p>InformerFactory로부터 PodInformer를 가져와서 변경 감지에 대한 처리를 할 수 있는 기본적이고 간단한 코드라고 할 수 있겠다. <code class="language-plaintext highlighter-rouge">main()</code> 함수를 하나하나 살펴보도록 하자.</p><p>16-20 라인은 <code class="language-plaintext highlighter-rouge">*rest.Config</code>를 가져오는 부분이다. Kubernetes API server에 대한 접근하기 위한 여러 정보를 포함하고 있다. 각자의 로컬에 있는 <strong>.kube/config</strong> 파일을 통해 빌드를 하는데 한가지 참고할 부분은 <code class="language-plaintext highlighter-rouge">kubeconfigPath</code>로 <strong>~/.kube/config</strong> 등의 상대 경로가 아닌 절대 경로로 입력해 주어야 할 수도 있다.</p><p>23-27 라인에서는 <code class="language-plaintext highlighter-rouge">*rest.Config</code>를 통해 <code class="language-plaintext highlighter-rouge">*kubernetes.Clientset</code>을 생성하고 있다. 모든 기본 Kubernetes 리소스에 대한 많은 클라이언트가 여기에 포함되어 있기 때문에 Clientset라고 한다.</p><p>32 라인에서 <a href="https://pkg.go.dev/k8s.io/client-go/informers@v0.23.1#SharedInformerFactory">SharedInformerFactory</a> 를 만든다. Shared informer factory는 informer들이 애플리케이션 내에서 동일한 리소스의 변경 사항을 공유할 수 있게 한다. 즉, 서로 다른 제어 루프에서 Shared informer factory를 통해 API server에 대한 동일한 watch 커넥션을 사용할 수 있다는 말이다. 이러한 특성으로 인해서 kube-controller-manager 내부에 있는 수많은 컨트롤러가 리소스에 대해 접근을 각자 하지만 프로세스 내에 존재하는 단일 informer를 통해 리소스 변경에 대한 이벤트를 전달받게 된다.</p><p>이 후 Pod informer를 가져와서 <code class="language-plaintext highlighter-rouge">cache.ResourceEventHandlerFuncs</code>를 사용해 <a href="https://pkg.go.dev/k8s.io/client-go/tools/cache@v0.23.1#ResourceEventHandler">ResourceEventHandler</a> 를 달아준다. ResourceEventHandler를 통해 해당 리소스에서 발생되는 이벤트에 대한 알림을 처리할 수 있다. 한 가지 명심해야할 사안은 핸들러 내부에서 수신된 객체를 직접 수정해서는 안된다.</p><dl><dt>OnAdd<dd>Object가 추가될 때 호출된다.<dt>OnUpdate<dd>Object가 수정될 때 호출된다. oldObj는 object의 변경에 따른 이벤트를 받기 전에 마지막으로 관찰된 상태이다. 여러 변경 사항이 결합되어 이벤트가 호출될 수 있으므로 이것을 단일 변경 사항에 대한 이벤트라 볼 순 없다.<dt>OnDelete<dd>Object가 삭제되기 전의 상태를 가져올 수 있으면 가져오고 그렇지 못한다면 DeletedFinalStateUnknown 유형의 object를 가져오게 된다. 후자의 경우는 watch event가 어떠한 문제로 인해 종료되어 삭제에 대한 이벤트를 놓쳤을 경우에 발생될 수 있다.</dl><p>위 이벤트에 대한 처리 로직을 작성하면 된다. 여기에선 간단히 로깅만 하는 정도로 해두었다.</p><p>마지막으로 53 라인에서 stop channel이 닫힐 때까지는 프로세스가 유지될 수 있도록 채널 수신을 받게 해두었다. 이제 바로 실행해보자.</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>❯ go mod tidy

❯ go run main.go
InformerFactory started
Add: kube-apiserver-minikube
Add: storage-provisioner
Add: coredns-78fcd69978-424p5
Add: kube-proxy-crjsd
Add: etcd-minikube
Add: kube-scheduler-minikube
Add: kube-controller-manager-minikube
Update: kube-apiserver-minikube
Update: storage-provisioner
Update: coredns-78fcd69978-424p5
Update: kube-proxy-crjsd
Update: etcd-minikube
...
</pre></table></code></div></div><p>Kubernetes 클러스터 위에 올라가 있는 모든 Pod들의 이벤트가 핸들링되고 있음을 확인할 수 있다. 모든 namespace의 pod를 관찰할 필요는 없으므로 관찰 범위를 줄여보자.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">namespaceOption</span> <span class="o">:=</span> <span class="n">informers</span><span class="o">.</span><span class="n">WithNamespace</span><span class="p">(</span><span class="s">"default"</span><span class="p">)</span>
<span class="n">informerFactory</span> <span class="o">:=</span> <span class="n">informers</span><span class="o">.</span><span class="n">NewSharedInformerFactoryWithOptions</span><span class="p">(</span><span class="n">clientset</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="o">*</span><span class="m">1</span><span class="p">,</span> <span class="n">namespaceOption</span><span class="p">)</span>
</pre></table></code></div></div><p>32 라인의 informerFactory를 생성하는 부분을 위와 같이 변경하고 다시 실행하자.</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>❯ go run main.go
InformerFactory started

<span class="c"># 한층 조용해졌다. 새로운 shell을 열어 nginx pod를 default namespace에 배포해보자.</span>
❯ kubectl run nginx <span class="nt">--image</span><span class="o">=</span>nginx
pod/nginx created

<span class="c"># 이제 다시 이전 shell로 돌아가보면</span>
Add: nginx
Update: nginx
Update: nginx
Update: nginx
Update: nginx
Update: nginx
...
</pre></table></code></div></div><p>nginx pod에 대한 이벤트가 핸들링되고 있음을 확인할 수 있다. 여기서 이상한 부분이 있다. OnUpdate 이벤트는 왜 계속 불려지고 있을까?</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="k">func</span><span class="p">(</span><span class="n">obj</span> <span class="k">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="c">// from oldest to newest</span>
  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">d</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">obj</span><span class="o">.</span><span class="p">(</span><span class="n">Deltas</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">obj</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">Object</span>
    <span class="k">if</span> <span class="n">transformer</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="k">var</span> <span class="n">err</span> <span class="kt">error</span>
      <span class="n">obj</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">transformer</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">err</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="n">d</span><span class="o">.</span><span class="n">Type</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">Sync</span><span class="p">,</span> <span class="n">Replaced</span><span class="p">,</span> <span class="n">Added</span><span class="p">,</span> <span class="n">Updated</span><span class="o">:</span>
      <span class="k">if</span> <span class="n">old</span><span class="p">,</span> <span class="n">exists</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">clientState</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span> <span class="n">err</span> <span class="o">==</span> <span class="no">nil</span> <span class="o">&amp;&amp;</span> <span class="n">exists</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">clientState</span><span class="o">.</span><span class="n">Update</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
          <span class="k">return</span> <span class="n">err</span>
        <span class="p">}</span>
        <span class="n">h</span><span class="o">.</span><span class="n">OnUpdate</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">clientState</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
          <span class="k">return</span> <span class="n">err</span>
        <span class="p">}</span>
        <span class="n">h</span><span class="o">.</span><span class="n">OnAdd</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="k">case</span> <span class="n">Deleted</span><span class="o">:</span>
      <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">clientState</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">err</span>
      <span class="p">}</span>
      <span class="n">h</span><span class="o">.</span><span class="n">OnDelete</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Informer에서는 <a href="https://pkg.go.dev/k8s.io/client-go/tools/cache#DeltaFIFO">DeltaFIFO</a> 에서 delta를 꺼내와 위와 같은 처리를 하게 된다. 13 라인부터의 switch 문을 보게 되면 Updated 타입 뿐만 아니라 Sync, Replaced와 같은 다른 타입 또한 <code class="language-plaintext highlighter-rouge">h.OnUpdate()</code>로 호출될 수 있는 것을 볼 수 있다.</p><p>Sync 타입은 informerFactory를 생성할 때 <code class="language-plaintext highlighter-rouge">defaultResync</code> 인자로 넘겨준 time.Duration과 밀접한 연관이 있다. 주기적으로 재동기화가 되며 이 기간동안 합성된 이벤트가 핸들러로 전달되게 된다. 위 작성된 코드에 따르면 1초마다 resync를 한다. 5초로 변경해보고 얼마나 자주 불리는지 확인해보자.</p><p>Replaced 타입은 watch event의 오류로 인해 re-list 작업을 해야할 때 발생된다. 앞서 정리했던 ListAndWatch 작업에서의 List라고 보면 된다.</p><p>이와 같은 다양한 변경 타입으로 인해 OnUpdate 이벤트는 지속적으로 호출되고 있는 것이다. 진짜 변경이 일어났을 경우에만 처리를 하고 싶다면 어떻게 해야할까? 우린 이미 <code class="language-plaintext highlighter-rouge">resourceVersion</code>이 무엇을 의미하는지 앞선 정리를 통해 알고 있는 상태이다. 당장 사용해보자.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">UpdateFunc</span><span class="o">:</span> <span class="k">func</span><span class="p">(</span><span class="n">oldObj</span><span class="p">,</span> <span class="n">newObj</span> <span class="k">interface</span><span class="p">{})</span> <span class="p">{</span>
  <span class="n">old</span> <span class="o">:=</span> <span class="n">oldObj</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">v1</span><span class="o">.</span><span class="n">Pod</span><span class="p">)</span>
  <span class="n">cur</span> <span class="o">:=</span> <span class="n">newObj</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">v1</span><span class="o">.</span><span class="n">Pod</span><span class="p">)</span>
  <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Update: "</span> <span class="o">+</span> <span class="n">cur</span><span class="o">.</span><span class="n">Name</span> <span class="o">+</span> <span class="s">", old RV: "</span> <span class="o">+</span> <span class="n">old</span><span class="o">.</span><span class="n">ResourceVersion</span> <span class="o">+</span> <span class="s">", new RV: "</span> <span class="o">+</span> <span class="n">cur</span><span class="o">.</span><span class="n">ResourceVersion</span><span class="p">)</span>
<span class="p">},</span>
</pre></table></code></div></div><p>UpdateFunc을 이렇게 변경하고 다시 실행해보자.</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>❯ go run main.go
InformerFactory started
Add: nginx
Update: nginx, old RV: 2206, new RV: 2206
Update: nginx, old RV: 2206, new RV: 2206
Update: nginx, old RV: 2206, new RV: 2206
...
</pre></table></code></div></div><p>old/new resourceVersion을 확인할 수 있다. object에 대한 변경이 전혀 없는데도 OnUpdate의 동작으로 인해 꾸준히 핸들링되고 있다.</p><p>이제 nginx pod에 변경을 가해보자. 간단히 label을 추가하는 작업을 해보고자 한다.</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>❯ kubectl label pods nginx <span class="nv">foo</span><span class="o">=</span>bar
pod/nginx labeled
<span class="nt">---</span>
Update: nginx, old RV: 2206, new RV: 2451 &lt;- pod/nginx labeled
Update: nginx, old RV: 2451, new RV: 2451
Update: nginx, old RV: 2451, new RV: 2451
</pre></table></code></div></div><p>nginx pod에 label이 추가되고 resourceVersion 또한 변경되었다. 이렇듯 object가 영속화되는 시점의 상태를 식별할 수 있는 resourceVersion을 사용하면 쉽게 변경 감지에 대한 이벤트를 처리할 수 있다.</p><h2 id="informers-architecture"><span class="mr-2">Informer’s Architecture</span><a href="#informers-architecture" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>이제 Informer가 어떤 형태로 구성되어 있는지 살펴보도록 하자. Kubernetes 소스 코드에 따른 Informer를 통한 watch event 전달 방식은 그림 1.과 같다.</p><p><img data-src="/images/informer-architecture.png" alt="informer-architecture" data-proofer-ignore> <em>그림 1. Informer가 watch event를 전달하는 방식</em></p><p>하나의 SharedInformer는 특정 API Group 및 kind/resource의 object에 대한 연결을 제공한다. object는 API Group, kind/resource, namespace 및 name으로 식별된다.</p><p>SharedInformer를 기반으로 Indexer 추가 및 가져오기 기능을 제공하는 SharedIndexInformer를 살펴보자. (informers.NewSharedInformer()를 호출하면 NewSharedIndexInformer를 반환한다.) SharedIndexInformer는 주요 컴포넌트인 Indexer, Controller, SharedProcessor를 확인하고 넘어가는 것이 좋겠다.</p><dl><dt>Indexer<dd>Indexer는 인덱싱된 로컬 캐시이다. object를 저장하고 처리하는 인터페이스인 Store를 여러 인덱스로 확장하며 DeltaFIFO에게는 KnownObjects 역할을 하며 object를 조회할 때 사용되는 Key의 목록을 제공해준다. 또한 클라이언트가 Lister를 통해 List/Get 요청을 하면 캐싱된 데이터를 전달해준다.<dt>Controller<dd>Controller는 실행될 때 지정된 리소스를 감시하고 모든 변경 사항이 지정된 Store에 저장되도록 하는 Reflector를 생성하면서 감시 작업에 ListerWatcher를 사용하도록 한다. ListerWatcher는 object/notification들을 가져오고 이를 DeltaFIFO로 push하는 동시에 해당 FIFO에서 pop하여 HandleDeltas로 Delta를 처리하는 컨트롤러이며 각 Delta에 대해 Indexer를 업데이트하고 관련 알림을 sharedProcessor에 채운다.<dt>SharedProcessor<dd>Informer의 모든 클라이언트(Listener를 통해)에 해당 알림을 전달하는 역할을 한다. 클라이언트에서 ResourceEventHandler를 추가하면 SharedProcessor의 Listener에 추가가 되어 알림을 지속적으로 받을 수 있게 된다.</dl><p>여기에서 DeltaFIFO는 주어진 객체의 변경 사항들에 대한 Delta를 항목으로 다루는 Queue이다. Informer가 실행될 때 생성되며 Pop(), Get(), GetByKey(), List()와 같은 method들을 제공한다.</p><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Inforemr는 특정 리소스에 대한 변경 감지가 필요한 수많은 클라이언트가 존재하더라도 하나의 watch connection으로 처리될 수 있도록 설계되었다. 변경 감지가 필요한 클라이언트는 단지 ResourceEventHandler를 추가하기만 하면 된다. 또한 Indexer에 캐싱된 데이터를 Lister를 통해서 접근해 사용할 수 있다.</p><p>그리고 Informer는 watch connection이 끊어지면 WatchErrorHandler를 호출한 후 Backoff 한다. 만약 중단된 기간이 길어져서 etcd가 event를 데이터베이스에서 삭제를 해 event가 손실되는 경우, Informer는 모든 object를 다시 나열(re-list)한다.</p><div class="language-go nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">Reflector</span><span class="p">)</span> <span class="n">Run</span><span class="p">(</span><span class="n">stopCh</span> <span class="o">&lt;-</span><span class="k">chan</span> <span class="k">struct</span><span class="p">{})</span> <span class="p">{</span>
  <span class="n">klog</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="m">3</span><span class="p">)</span><span class="o">.</span><span class="n">Infof</span><span class="p">(</span><span class="s">"Starting reflector %s (%s) from %s"</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">expectedTypeName</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">resyncPeriod</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
  <span class="n">wait</span><span class="o">.</span><span class="n">BackoffUntil</span><span class="p">(</span><span class="k">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="n">ListAndWatch</span><span class="p">(</span><span class="n">stopCh</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="n">r</span><span class="o">.</span><span class="n">watchErrorHandler</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">},</span> <span class="n">r</span><span class="o">.</span><span class="n">backoffManager</span><span class="p">,</span> <span class="no">true</span><span class="p">,</span> <span class="n">stopCh</span><span class="p">)</span>
  <span class="n">klog</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="m">3</span><span class="p">)</span><span class="o">.</span><span class="n">Infof</span><span class="p">(</span><span class="s">"Stopping reflector %s (%s) from %s"</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">expectedTypeName</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">resyncPeriod</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>클라이언트가 Informer를 사용하지 않고 Watch() verb를 사용했다면 이러한 작업들을 직접해야만 하거나, 그렇지 않다면 event를 놓치게 될 것이다.</p><p>이러한 이유들로 Informer의 사용이 권장되고 있다. 이제 마지막으로 Kubernetes의 Event에 대해 파악해보자.</p><div style="text-align: center; font-weight: bold; margin-top: 100px; margin-bottom: 50px">끝.</div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kubernetes/'>kubernetes</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >kubernetes</a> <a href="/tags/watch/" class="post-tag no-text-decoration" >watch</a> <a href="/tags/event/" class="post-tag no-text-decoration" >event</a> <a href="/tags/apiserver/" class="post-tag no-text-decoration" >apiserver</a> <a href="/tags/gorestful/" class="post-tag no-text-decoration" >gorestful</a> <a href="/tags/informer/" class="post-tag no-text-decoration" >informer</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Informer%EC%9D%98+%EA%B5%AC%EC%A1%B0+-+wq.lee&url=https%3A%2F%2Fblog.wqlee.com%2Fposts%2Fwhat-is-a-kubernetes-watch-event-3rd%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Informer%EC%9D%98+%EA%B5%AC%EC%A1%B0+-+wq.lee&u=https%3A%2F%2Fblog.wqlee.com%2Fposts%2Fwhat-is-a-kubernetes-watch-event-3rd%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fblog.wqlee.com%2Fposts%2Fwhat-is-a-kubernetes-watch-event-3rd%2F&text=Informer%EC%9D%98+%EA%B5%AC%EC%A1%B0+-+wq.lee" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fblog.wqlee.com%2Fposts%2Fwhat-is-a-kubernetes-watch-event-3rd%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/cgroups-and-kubernetes/">Control groups & Kubernetes</a><li><a href="/posts/what-is-a-kubernetes-watch-event-4rd/">Event란건 어쩌면 어려운게 아닐까</a><li><a href="/posts/scheduling-in-go-01/">Scheduling In Go I - OS Scheduler</a><li><a href="/posts/what-is-a-kubernetes-watch-event-3rd/">Informer의 구조</a><li><a href="/posts/what-is-a-kubernetes-watch-event-2nd/">Watch Server에 요청이 도달하기까지의 과정</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/event/">event</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/watch/">watch</a> <a class="post-tag" href="/tags/os/">os</a> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/apiserver/">apiserver</a> <a class="post-tag" href="/tags/go/">go</a> <a class="post-tag" href="/tags/gorestful/">gorestful</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/scheduler/">scheduler</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/what-is-a-kubernetes-watch-event-2nd/"><div class="card-body"> <em class="timeago small" data-ts="1640962800" > 2022-01-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Watch Server에 요청이 도달하기까지의 과정</h3><div class="text-muted small"><p> 앞서 클라이언트와 API server가 어떤 방식으로 Watch event를 요청하고 응답하는지 확인해봤다. 이번에는 좀 더 깊게 들어가서 API server가 Watch event에 대한 응답을 하기 위해 어떤 준비를 하는지, Watch Server 생성까지의 구현 부분을 알아볼 차례이다. 분석하는 와중에 정말 많은 용어들이 등장했는데 내부적으로 ...</p></div></div></a></div><div class="card"> <a href="/posts/basic-etcd/"><div class="card-body"> <em class="timeago small" data-ts="1642600800" > 2022-01-19 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Basic ETCD</h3><div class="text-muted small"><p> Highly Available Fully Replicated Strong consistency model Scalable watch mechanism Concurrency control primitives Distributed Key/Value store Distributed consensus is a fancy way to e...</p></div></div></a></div><div class="card"> <a href="/posts/what-is-a-kubernetes-watch-event-4rd/"><div class="card-body"> <em class="timeago small" data-ts="1643454000" > 2022-01-29 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Event란건 어쩌면 어려운게 아닐까</h3><div class="text-muted small"><p> Kubernetes Architecture Kubernetes는 microservice 기반의 아키텍처가 적용되어 있다. Control Plane, Worker Node의 컴포넌트들은 개별 서비스로 구현된다. 특히 Control Plane은 Event와 함께 느슨하게 결합된 구성 요소의 원칙을 많이 접목시켜 사용하고 있다. 이러한 아키텍처의 주요 이...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/what-is-a-kubernetes-watch-event-2nd/" class="btn btn-outline-primary" prompt="Older"><p>Watch Server에 요청이 도달하기까지의 과정</p></a> <a href="/posts/basic-etcd/" class="btn btn-outline-primary" prompt="Newer"><p>Basic ETCD</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://www.linkedin.com/in/wq-lee">Wongyu Lee</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/event/">event</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/watch/">watch</a> <a class="post-tag" href="/tags/os/">os</a> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/apiserver/">apiserver</a> <a class="post-tag" href="/tags/go/">go</a> <a class="post-tag" href="/tags/gorestful/">gorestful</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/scheduler/">scheduler</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-4PS0JXVL1J"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-4PS0JXVL1J'); }); </script>
