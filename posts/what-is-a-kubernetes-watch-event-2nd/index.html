<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Watch Server에 요청이 도달하기까지의 과정" /><meta name="author" content="Wongyu Lee" /><meta property="og:locale" content="en" /><meta name="description" content="앞서 클라이언트와 API server가 어떤 방식으로 Watch event를 요청하고 응답하는지 확인해봤다. 이번에는 좀 더 깊게 들어가서 API server가 Watch event에 대한 응답을 하기 위해 어떤 준비를 하는지, Watch Server 생성까지의 구현 부분을 알아볼 차례이다." /><meta property="og:description" content="앞서 클라이언트와 API server가 어떤 방식으로 Watch event를 요청하고 응답하는지 확인해봤다. 이번에는 좀 더 깊게 들어가서 API server가 Watch event에 대한 응답을 하기 위해 어떤 준비를 하는지, Watch Server 생성까지의 구현 부분을 알아볼 차례이다." /><link rel="canonical" href="https://blog.wqlee.com/posts/what-is-a-kubernetes-watch-event-2nd/" /><meta property="og:url" content="https://blog.wqlee.com/posts/what-is-a-kubernetes-watch-event-2nd/" /><meta property="og:site_name" content="wq.lee" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-01-01T00:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Watch Server에 요청이 도달하기까지의 과정" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Wongyu Lee","url":"https://github.com/21kyu"},"dateModified":"2022-04-12T10:05:22+09:00","datePublished":"2022-01-01T00:00:00+09:00","description":"앞서 클라이언트와 API server가 어떤 방식으로 Watch event를 요청하고 응답하는지 확인해봤다. 이번에는 좀 더 깊게 들어가서 API server가 Watch event에 대한 응답을 하기 위해 어떤 준비를 하는지, Watch Server 생성까지의 구현 부분을 알아볼 차례이다.","headline":"Watch Server에 요청이 도달하기까지의 과정","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.wqlee.com/posts/what-is-a-kubernetes-watch-event-2nd/"},"url":"https://blog.wqlee.com/posts/what-is-a-kubernetes-watch-event-2nd/"}</script><title>Watch Server에 요청이 도달하기까지의 과정 | wq.lee</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="wq.lee"><meta name="application-name" content="wq.lee"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/avata.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">wq.lee</a></div><div class="site-subtitle font-italic">룰루랄라 즐거웁다 쿠버네티스</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/21kyu" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/wq-lee" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['qoo','kakao.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Watch Server에 요청이 도달하기까지의 과정</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Watch Server에 요청이 도달하기까지의 과정</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/21kyu">Wongyu Lee</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1640962800" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-01-01 </em> </span> <span> Updated <em class="timeago" data-ts="1649725522" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-04-12 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3657 words"> <em>20 min</em> read</span></div></div></div><div class="post-content"><p>앞서 클라이언트와 API server가 어떤 방식으로 Watch event를 요청하고 응답하는지 확인해봤다. 이번에는 좀 더 깊게 들어가서 API server가 Watch event에 대한 응답을 하기 위해 어떤 준비를 하는지, Watch Server 생성까지의 구현 부분을 알아볼 차례이다.</p><p>분석하는 와중에 정말 많은 용어들이 등장했는데 내부적으로 왜 이러한 네이밍을 했는지 Ubiquitous Language를 선정할 때 오고 갔던 많은 내용들이 궁금해지기도 했다. 이러한 용어들도 같이 정리해볼까 한다.</p><h3 id="prerequisites"><span class="mr-2">Prerequisites</span><a href="#prerequisites" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li><a href="https://github.com/kubernetes/kubernetes">Kubernetes Source Code</a></ul><h2 id="api-server-analysis"><span class="mr-2">API Server analysis</span><a href="#api-server-analysis" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><a href="https://github.com/kubernetes/kubernetes/blob/7c013c3f64db33cf19f38bb2fc8d9182e42b0b7b/cmd/kube-apiserver/app/server.go#L84">server.go</a> 를 보면 여느 kubernetes component들과 마찬가지로 kube-apiserver는 cobra.Command <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> 를 사용해 시작되는걸로 확인이 된다.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="n">NewAPIServerCommand</span><span class="p">()</span> <span class="o">*</span><span class="n">cobra</span><span class="o">.</span><span class="n">Command</span> <span class="p">{</span>
  <span class="n">s</span> <span class="o">:=</span> <span class="n">options</span><span class="o">.</span><span class="n">NewServerRunOptions</span><span class="p">()</span>
  <span class="n">cmd</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">cobra</span><span class="o">.</span><span class="n">Command</span><span class="p">{</span>
    <span class="n">Use</span><span class="o">:</span> <span class="s">"kube-apiserver"</span><span class="p">,</span>
    <span class="c">// ...</span>
    <span class="n">RunE</span><span class="o">:</span> <span class="k">func</span><span class="p">(</span><span class="n">cmd</span> <span class="o">*</span><span class="n">cobra</span><span class="o">.</span><span class="n">Command</span><span class="p">,</span> <span class="n">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
      <span class="c">// ...</span>

      <span class="c">// set default options</span>
      <span class="n">completedOptions</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">Complete</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">err</span>
      <span class="p">}</span>

      <span class="c">// validate options</span>
      <span class="k">if</span> <span class="n">errs</span> <span class="o">:=</span> <span class="n">completedOptions</span><span class="o">.</span><span class="n">Validate</span><span class="p">();</span> <span class="nb">len</span><span class="p">(</span><span class="n">errs</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">utilerrors</span><span class="o">.</span><span class="n">NewAggregate</span><span class="p">(</span><span class="n">errs</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="n">Run</span><span class="p">(</span><span class="n">completedOptions</span><span class="p">,</span> <span class="n">genericapiserver</span><span class="o">.</span><span class="n">SetupSignalHandler</span><span class="p">())</span>
    <span class="p">},</span>

  <span class="c">// ...</span>

  <span class="k">return</span> <span class="n">cmd</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="serverchain"><span class="mr-2">ServerChain</span><a href="#serverchain" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>cobra.Command의 RunE function에서 completedOptions를 설정하고 해당 옵션이 유효한지 확인한다. 그리고 지정된 APIServer를 생성하고 실행하는 <code class="language-plaintext highlighter-rouge">Run()</code> method를 호출한다. <code class="language-plaintext highlighter-rouge">Run()</code> method 내부에서 호출되는 <code class="language-plaintext highlighter-rouge">CreateServerChain()</code> method를 살펴보자.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="n">CreateServerChain</span><span class="p">(</span><span class="n">completedOptions</span> <span class="n">completedServerRunOptions</span><span class="p">,</span> <span class="n">stopCh</span> <span class="o">&lt;-</span><span class="k">chan</span> <span class="k">struct</span><span class="p">{})</span> <span class="p">(</span><span class="o">*</span><span class="n">aggregatorapiserver</span><span class="o">.</span><span class="n">APIAggregator</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">kubeAPIServerConfig</span><span class="p">,</span> <span class="n">serviceResolver</span><span class="p">,</span> <span class="n">pluginInitializer</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">CreateKubeAPIServerConfig</span><span class="p">(</span><span class="n">completedOptions</span><span class="p">)</span>
  <span class="c">// ...</span>
  <span class="n">apiExtensionsConfig</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">createAPIExtensionsConfig</span><span class="p">(</span><span class="o">*</span><span class="n">kubeAPIServerConfig</span><span class="o">.</span><span class="n">GenericConfig</span><span class="p">,</span> <span class="n">kubeAPIServerConfig</span><span class="o">.</span><span class="n">ExtraConfig</span><span class="o">.</span><span class="n">VersionedInformers</span><span class="p">,</span> <span class="n">pluginInitializer</span><span class="p">,</span> <span class="n">completedOptions</span><span class="o">.</span><span class="n">ServerRunOptions</span><span class="p">,</span> <span class="n">completedOptions</span><span class="o">.</span><span class="n">MasterCount</span><span class="p">,</span>
    <span class="n">serviceResolver</span><span class="p">,</span> <span class="n">webhook</span><span class="o">.</span><span class="n">NewDefaultAuthenticationInfoResolverWrapper</span><span class="p">(</span><span class="n">kubeAPIServerConfig</span><span class="o">.</span><span class="n">ExtraConfig</span><span class="o">.</span><span class="n">ProxyTransport</span><span class="p">,</span> <span class="n">kubeAPIServerConfig</span><span class="o">.</span><span class="n">GenericConfig</span><span class="o">.</span><span class="n">EgressSelector</span><span class="p">,</span> <span class="n">kubeAPIServerConfig</span><span class="o">.</span><span class="n">GenericConfig</span><span class="o">.</span><span class="n">LoopbackClientConfig</span><span class="p">,</span> <span class="n">kubeAPIServerConfig</span><span class="o">.</span><span class="n">GenericConfig</span><span class="o">.</span><span class="n">TracerProvider</span><span class="p">))</span>
  <span class="c">// ...</span>

  <span class="n">apiExtensionsServer</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">createAPIExtensionsServer</span><span class="p">(</span><span class="n">apiExtensionsConfig</span><span class="p">,</span> <span class="n">genericapiserver</span><span class="o">.</span><span class="n">NewEmptyDelegateWithCustomHandler</span><span class="p">(</span><span class="n">notFoundHandler</span><span class="p">))</span>
  <span class="c">// ...</span>
  <span class="n">kubeAPIServer</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">CreateKubeAPIServer</span><span class="p">(</span><span class="n">kubeAPIServerConfig</span><span class="p">,</span> <span class="n">apiExtensionsServer</span><span class="o">.</span><span class="n">GenericAPIServer</span><span class="p">)</span>
  <span class="c">// ...</span>
  <span class="n">aggregatorConfig</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">createAggregatorConfig</span><span class="p">(</span><span class="o">*</span><span class="n">kubeAPIServerConfig</span><span class="o">.</span><span class="n">GenericConfig</span><span class="p">,</span> <span class="n">completedOptions</span><span class="o">.</span><span class="n">ServerRunOptions</span><span class="p">,</span> <span class="n">kubeAPIServerConfig</span><span class="o">.</span><span class="n">ExtraConfig</span><span class="o">.</span><span class="n">VersionedInformers</span><span class="p">,</span> <span class="n">serviceResolver</span><span class="p">,</span> <span class="n">kubeAPIServerConfig</span><span class="o">.</span><span class="n">ExtraConfig</span><span class="o">.</span><span class="n">ProxyTransport</span><span class="p">,</span> <span class="n">pluginInitializer</span><span class="p">)</span>
  <span class="c">// ...</span>
  <span class="n">aggregatorServer</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">createAggregatorServer</span><span class="p">(</span><span class="n">aggregatorConfig</span><span class="p">,</span> <span class="n">kubeAPIServer</span><span class="o">.</span><span class="n">GenericAPIServer</span><span class="p">,</span> <span class="n">apiExtensionsServer</span><span class="o">.</span><span class="n">Informers</span><span class="p">)</span>
  <span class="c">// ...</span>
  <span class="k">return</span> <span class="n">aggregatorServer</span><span class="p">,</span> <span class="no">nil</span>
<span class="p">}</span>
</pre></table></code></div></div><p>completedOptions의 설정에 따라 kubeAPIServerConfig와 Extension API server를 위한 apiExtensionsConfig를 통해 기본 API server와 Extended API server를 만들고 생성된 두 API server의 access를 통합하는 Aggregator Server를 생성하여 반환한다. Extension API server는 <code class="language-plaintext highlighter-rouge">customresourcedefinitions</code> resource를 관리하게 되며 나머지 api-resources들은 kubeAPIServer가 관리하게 된다.</p><p><em>Aggregation Architecture에 대한 지식이 있으면 매우 유용할 것이라는 이야기를 전해들었기에 AggregatorServer와 관련해서 Aggregation layer <sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup> 와 어떠한 연관이 있는지 추후에 확인해보도록 하자.</em></p><p>이제 CreateKubeAPIServer method를 확인해보자.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="n">CreateKubeAPIServer</span><span class="p">(</span><span class="n">kubeAPIServerConfig</span> <span class="o">*</span><span class="n">controlplane</span><span class="o">.</span><span class="n">Config</span><span class="p">,</span> <span class="n">delegateAPIServer</span> <span class="n">genericapiserver</span><span class="o">.</span><span class="n">DelegationTarget</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">controlplane</span><span class="o">.</span><span class="n">Instance</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">kubeAPIServer</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">kubeAPIServerConfig</span><span class="o">.</span><span class="n">Complete</span><span class="p">()</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">delegateAPIServer</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">err</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">kubeAPIServer</span><span class="p">,</span> <span class="no">nil</span>
<span class="p">}</span>
</pre></table></code></div></div><p><em>Line:2</em>의 <code class="language-plaintext highlighter-rouge">kubeAPIServerConfig.Complete().New(delegateAPIServer)</code> 코드가 보인다. <code class="language-plaintext highlighter-rouge">Complete()</code> method를 통해 유효한 데이터가 존재해야하는 모든 설정되지 않은 필드를 채우고 <code class="language-plaintext highlighter-rouge">New()</code> method를 통해 kube-apiserver의 구성을 생성한다.</p><h3 id="apiserverhandlers"><span class="mr-2">APIServerHandlers</span><a href="#apiserverhandlers" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="n">completedConfig</span><span class="p">)</span> <span class="n">New</span><span class="p">(</span><span class="n">delegationTarget</span> <span class="n">genericapiserver</span><span class="o">.</span><span class="n">DelegationTarget</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">Instance</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c">// ...</span>

  <span class="n">s</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">c</span><span class="o">.</span><span class="n">GenericConfig</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"kube-apiserver"</span><span class="p">,</span> <span class="n">delegationTarget</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">err</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">ExtraConfig</span><span class="o">.</span><span class="n">EnableLogsSupport</span> <span class="p">{</span>
    <span class="n">routes</span><span class="o">.</span><span class="n">Logs</span><span class="p">{}</span><span class="o">.</span><span class="n">Install</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">Handler</span><span class="o">.</span><span class="n">GoRestfulContainer</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c">// ...</span>

  <span class="n">m</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Instance</span><span class="p">{</span>
    <span class="n">GenericAPIServer</span><span class="o">:</span>          <span class="n">s</span><span class="p">,</span>
    <span class="n">ClusterAuthenticationInfo</span><span class="o">:</span> <span class="n">c</span><span class="o">.</span><span class="n">ExtraConfig</span><span class="o">.</span><span class="n">ClusterAuthenticationInfo</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">ExtraConfig</span><span class="o">.</span><span class="n">APIResourceConfigSource</span><span class="o">.</span><span class="n">VersionEnabled</span><span class="p">(</span><span class="n">apiv1</span><span class="o">.</span><span class="n">SchemeGroupVersion</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">legacyRESTStorageProvider</span> <span class="o">:=</span> <span class="n">corerest</span><span class="o">.</span><span class="n">LegacyRESTStorageProvider</span><span class="p">{</span>
      <span class="n">StorageFactory</span><span class="o">:</span>              <span class="n">c</span><span class="o">.</span><span class="n">ExtraConfig</span><span class="o">.</span><span class="n">StorageFactory</span><span class="p">,</span>
      <span class="n">ProxyTransport</span><span class="o">:</span>              <span class="n">c</span><span class="o">.</span><span class="n">ExtraConfig</span><span class="o">.</span><span class="n">ProxyTransport</span><span class="p">,</span>
      <span class="n">KubeletClientConfig</span><span class="o">:</span>         <span class="n">c</span><span class="o">.</span><span class="n">ExtraConfig</span><span class="o">.</span><span class="n">KubeletClientConfig</span><span class="p">,</span>
      <span class="n">EventTTL</span><span class="o">:</span>                    <span class="n">c</span><span class="o">.</span><span class="n">ExtraConfig</span><span class="o">.</span><span class="n">EventTTL</span><span class="p">,</span>
      <span class="n">ServiceIPRange</span><span class="o">:</span>              <span class="n">c</span><span class="o">.</span><span class="n">ExtraConfig</span><span class="o">.</span><span class="n">ServiceIPRange</span><span class="p">,</span>
      <span class="n">SecondaryServiceIPRange</span><span class="o">:</span>     <span class="n">c</span><span class="o">.</span><span class="n">ExtraConfig</span><span class="o">.</span><span class="n">SecondaryServiceIPRange</span><span class="p">,</span>
      <span class="n">ServiceNodePortRange</span><span class="o">:</span>        <span class="n">c</span><span class="o">.</span><span class="n">ExtraConfig</span><span class="o">.</span><span class="n">ServiceNodePortRange</span><span class="p">,</span>
      <span class="n">LoopbackClientConfig</span><span class="o">:</span>        <span class="n">c</span><span class="o">.</span><span class="n">GenericConfig</span><span class="o">.</span><span class="n">LoopbackClientConfig</span><span class="p">,</span>
      <span class="n">ServiceAccountIssuer</span><span class="o">:</span>        <span class="n">c</span><span class="o">.</span><span class="n">ExtraConfig</span><span class="o">.</span><span class="n">ServiceAccountIssuer</span><span class="p">,</span>
      <span class="n">ExtendExpiration</span><span class="o">:</span>            <span class="n">c</span><span class="o">.</span><span class="n">ExtraConfig</span><span class="o">.</span><span class="n">ExtendExpiration</span><span class="p">,</span>
      <span class="n">ServiceAccountMaxExpiration</span><span class="o">:</span> <span class="n">c</span><span class="o">.</span><span class="n">ExtraConfig</span><span class="o">.</span><span class="n">ServiceAccountMaxExpiration</span><span class="p">,</span>
      <span class="n">APIAudiences</span><span class="o">:</span>                <span class="n">c</span><span class="o">.</span><span class="n">GenericConfig</span><span class="o">.</span><span class="n">Authentication</span><span class="o">.</span><span class="n">APIAudiences</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">m</span><span class="o">.</span><span class="n">InstallLegacyAPI</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">GenericConfig</span><span class="o">.</span><span class="n">RESTOptionsGetter</span><span class="p">,</span> <span class="n">legacyRESTStorageProvider</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">err</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">restStorageProviders</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">RESTStorageProvider</span><span class="p">{</span>
    <span class="n">apiserverinternalrest</span><span class="o">.</span><span class="n">StorageProvider</span><span class="p">{},</span>
    <span class="n">authenticationrest</span><span class="o">.</span><span class="n">RESTStorageProvider</span><span class="p">{</span><span class="n">Authenticator</span><span class="o">:</span> <span class="n">c</span><span class="o">.</span><span class="n">GenericConfig</span><span class="o">.</span><span class="n">Authentication</span><span class="o">.</span><span class="n">Authenticator</span><span class="p">,</span> <span class="n">APIAudiences</span><span class="o">:</span> <span class="n">c</span><span class="o">.</span><span class="n">GenericConfig</span><span class="o">.</span><span class="n">Authentication</span><span class="o">.</span><span class="n">APIAudiences</span><span class="p">},</span>
    <span class="n">authorizationrest</span><span class="o">.</span><span class="n">RESTStorageProvider</span><span class="p">{</span><span class="n">Authorizer</span><span class="o">:</span> <span class="n">c</span><span class="o">.</span><span class="n">GenericConfig</span><span class="o">.</span><span class="n">Authorization</span><span class="o">.</span><span class="n">Authorizer</span><span class="p">,</span> <span class="n">RuleResolver</span><span class="o">:</span> <span class="n">c</span><span class="o">.</span><span class="n">GenericConfig</span><span class="o">.</span><span class="n">RuleResolver</span><span class="p">},</span>
    <span class="n">autoscalingrest</span><span class="o">.</span><span class="n">RESTStorageProvider</span><span class="p">{},</span>
    <span class="n">batchrest</span><span class="o">.</span><span class="n">RESTStorageProvider</span><span class="p">{},</span>
    <span class="n">certificatesrest</span><span class="o">.</span><span class="n">RESTStorageProvider</span><span class="p">{},</span>
    <span class="n">coordinationrest</span><span class="o">.</span><span class="n">RESTStorageProvider</span><span class="p">{},</span>
    <span class="n">discoveryrest</span><span class="o">.</span><span class="n">StorageProvider</span><span class="p">{},</span>
    <span class="n">networkingrest</span><span class="o">.</span><span class="n">RESTStorageProvider</span><span class="p">{},</span>
    <span class="n">noderest</span><span class="o">.</span><span class="n">RESTStorageProvider</span><span class="p">{},</span>
    <span class="n">policyrest</span><span class="o">.</span><span class="n">RESTStorageProvider</span><span class="p">{},</span>
    <span class="n">rbacrest</span><span class="o">.</span><span class="n">RESTStorageProvider</span><span class="p">{</span><span class="n">Authorizer</span><span class="o">:</span> <span class="n">c</span><span class="o">.</span><span class="n">GenericConfig</span><span class="o">.</span><span class="n">Authorization</span><span class="o">.</span><span class="n">Authorizer</span><span class="p">},</span>
    <span class="n">schedulingrest</span><span class="o">.</span><span class="n">RESTStorageProvider</span><span class="p">{},</span>
    <span class="n">storagerest</span><span class="o">.</span><span class="n">RESTStorageProvider</span><span class="p">{},</span>
    <span class="n">flowcontrolrest</span><span class="o">.</span><span class="n">RESTStorageProvider</span><span class="p">{},</span>
    <span class="n">appsrest</span><span class="o">.</span><span class="n">StorageProvider</span><span class="p">{},</span>
    <span class="n">admissionregistrationrest</span><span class="o">.</span><span class="n">RESTStorageProvider</span><span class="p">{},</span>
    <span class="n">eventsrest</span><span class="o">.</span><span class="n">RESTStorageProvider</span><span class="p">{</span><span class="n">TTL</span><span class="o">:</span> <span class="n">c</span><span class="o">.</span><span class="n">ExtraConfig</span><span class="o">.</span><span class="n">EventTTL</span><span class="p">},</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">m</span><span class="o">.</span><span class="n">InstallAPIs</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">ExtraConfig</span><span class="o">.</span><span class="n">APIResourceConfigSource</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">GenericConfig</span><span class="o">.</span><span class="n">RESTOptionsGetter</span><span class="p">,</span> <span class="n">restStorageProviders</span><span class="o">...</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">err</span>
  <span class="p">}</span>

  <span class="c">// ...</span>

  <span class="k">return</span> <span class="n">m</span><span class="p">,</span> <span class="no">nil</span>
<span class="p">}</span>
</pre></table></code></div></div><p>이 method는 먼저 <em>Line:4</em>의 <code class="language-plaintext highlighter-rouge">New("kube-apiserver", delegationTarget)</code>에서 APIServerHandlers를 생성한다. 여기에는 FullHandlerChain과 Director, 그리고 GoRestfulContainer와 NonGoRestfulMux가 포함된다.</p><dl><dt>GoRestfulContainer<dd>클라이언트에서 pods, deployments, services 등의 리소스들에 접근할 때 사용되는 /apis/*와 같은 API들이 등록되며 <a href="https://pkg.go.dev/github.com/emicklei/go-restful#section-readme">go-restful</a> design pattern을 준수하는 <a href="https://pkg.go.dev/github.com/emicklei/go-restful@v2.9.5+incompatible#Container">*restful.Container</a> 이다. 즉, Container는 HTTP 요청을 다중화하기 위한 <a href="https://pkg.go.dev/github.com/emicklei/go-restful@v2.9.5+incompatible#WebService">WebService</a> collection을 보유하며 WebService에는 root path가 지정되며 최종적으로 path와 method가 <a href="https://pkg.go.dev/github.com/emicklei/go-restful@v2.9.5+incompatible#Route">Route</a> 에 의해 바인딩된다.<dt>NonGoRestfulMux<dd>chain에서 가장 마지막에 호출되는 HTTP handler이다. mux 객체를 래핑하고 exposedPaths를 기록하는 *mux.PathRecorderMux이며 모든 filter와 API가 처리된 후에 불리게 된다. 여기를 통해 다른 서버들이 chain의 다양한 부분에 handler를 추가할 수 있다.<dt>Director<dd>해당 path가 GoRestfulContainer에 의해 처리될 수 있는지를 확인하고 호출하며, 만약 처리될 수 없는 요청이면 NonGoRestfulMux를 호출해 정상적으로 응답이 될 수 있도록 유도한다. 이렇게 동작하는 Director에 의해 실패 및 프록시 케이스를 적절히 처리할 수 있게 된다. <code class="language-plaintext highlighter-rouge">apis</code>를 gorestful에 등록하면 <code class="language-plaintext highlighter-rouge">/apis</code> 또는 <code class="language-plaintext highlighter-rouge">/apis/*</code>가 아닌 모든 요청은 404 응답이 전달되며 다른 모든 것을 포함하는 패턴 등록 시도는 gorestful 제약에 의해 실패하게 된다. 이에 mux가 필요한 것이다. Kubernetes에서는 요청이 gorestful에서 처리할 수 없는 path를 포함할 경우 mux로 위임해서 처리하도록 설계했다.<dt>FullHandlerChain<dd>HTTP 요청에 응답하는 http.Handler이다. 전체 filter chain가 포함된 상태에서 Director를 호출하게 된다.</dl><p><img data-src="/images/http-request-flow.png" alt="HTTP Request Flow" data-proofer-ignore> <em>그림 1: HTTP 요청이 전달되었을 때의 호출 순서</em></p><p>생성된 APIServerHandler를 통해 <code class="language-plaintext highlighter-rouge">/</code>, <code class="language-plaintext highlighter-rouge">/debug/*</code>, <code class="language-plaintext highlighter-rouge">/metrics/</code>, <code class="language-plaintext highlighter-rouge">version</code>을 포함한 여러 path를 GoRestfulContainer와 NonGoRestfulMux에 추가한다. 또한 logs 관련 라우팅을 지원하는지 확인 후 <code class="language-plaintext highlighter-rouge">/logs</code> path를 추가한다.</p><div class="language-shell nolineno highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>❯ kubectl get pods <span class="nt">-A</span> <span class="nt">-v</span> 6
GET https://192.168.49.2:8443/api/v1/pods?limit<span class="o">=</span>500 200 OK <span class="k">in </span>15 milliseconds

❯ kubectl get deployments <span class="nt">-A</span> <span class="nt">-v</span> 6
GET https://192.168.49.2:8443/apis/apps/v1/deployments?limit<span class="o">=</span>500 200 OK <span class="k">in </span>12 milliseconds
</pre></table></code></div></div><p><em>: pods와 deployments의 URL 확인</em></p><p>Kubernetes는 처음 pods와 같은 리소스를 만들 때에는 <code class="language-plaintext highlighter-rouge">/api</code>이 root path로 붙도록 설계되었고 이후 추가되는 deployments와 같은 리소스들은 <code class="language-plaintext highlighter-rouge">/apis</code>를 root path로 시작하도록 설계하고 있어서 이러한 리소스들을 <em>Line:35</em>, <em>Line:60</em>의 <code class="language-plaintext highlighter-rouge">InstallLegacyAPI()</code> &amp; <code class="language-plaintext highlighter-rouge">InstallAPIs()</code>에서 각각 바인딩해주고 있다.</p><p><code class="language-plaintext highlighter-rouge">InstallLegacyAPI()</code>와 <code class="language-plaintext highlighter-rouge">InstallAPIs()</code>는 <a href="https://pkg.go.dev/k8s.io/apiserver/pkg/registry/rest#Storage">RESTStorage</a> 를 얻는 방식의 차이가 조금 있고 내부 동작은 거의 비슷하다. <code class="language-plaintext highlighter-rouge">InstallAPIs()</code>를 살펴보자.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span><span class="n">Instance</span><span class="p">)</span> <span class="n">InstallAPIs</span><span class="p">(</span><span class="n">apiResourceConfigSource</span> <span class="n">serverstorage</span><span class="o">.</span><span class="n">APIResourceConfigSource</span><span class="p">,</span> <span class="n">restOptionsGetter</span> <span class="n">generic</span><span class="o">.</span><span class="n">RESTOptionsGetter</span><span class="p">,</span> <span class="n">restStorageProviders</span> <span class="o">...</span><span class="n">RESTStorageProvider</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="n">apiGroupsInfo</span> <span class="o">:=</span> <span class="p">[]</span><span class="o">*</span><span class="n">genericapiserver</span><span class="o">.</span><span class="n">APIGroupInfo</span><span class="p">{}</span>

  <span class="c">// used later in the loop to filter the served resource by those that have expired.</span>
  <span class="n">resourceExpirationEvaluator</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">genericapiserver</span><span class="o">.</span><span class="n">NewResourceExpirationEvaluator</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">GenericAPIServer</span><span class="o">.</span><span class="n">Version</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">err</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">restStorageBuilder</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">restStorageProviders</span> <span class="p">{</span>
    <span class="n">groupName</span> <span class="o">:=</span> <span class="n">restStorageBuilder</span><span class="o">.</span><span class="n">GroupName</span><span class="p">()</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">apiResourceConfigSource</span><span class="o">.</span><span class="n">AnyVersionForGroupEnabled</span><span class="p">(</span><span class="n">groupName</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">klog</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="o">.</span><span class="n">Infof</span><span class="p">(</span><span class="s">"Skipping disabled API group %q."</span><span class="p">,</span> <span class="n">groupName</span><span class="p">)</span>
      <span class="k">continue</span>
    <span class="p">}</span>
    <span class="n">apiGroupInfo</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">restStorageBuilder</span><span class="o">.</span><span class="n">NewRESTStorage</span><span class="p">(</span><span class="n">apiResourceConfigSource</span><span class="p">,</span> <span class="n">restOptionsGetter</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"problem initializing API group %q : %v"</span><span class="p">,</span> <span class="n">groupName</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">enabled</span> <span class="p">{</span>
      <span class="n">klog</span><span class="o">.</span><span class="n">Warningf</span><span class="p">(</span><span class="s">"API group %q is not enabled, skipping."</span><span class="p">,</span> <span class="n">groupName</span><span class="p">)</span>
      <span class="k">continue</span>
    <span class="p">}</span>

    <span class="c">// ...</span>

    <span class="n">apiGroupsInfo</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">apiGroupsInfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">apiGroupInfo</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">m</span><span class="o">.</span><span class="n">GenericAPIServer</span><span class="o">.</span><span class="n">InstallAPIGroups</span><span class="p">(</span><span class="n">apiGroupsInfo</span><span class="o">...</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"error in registering group versions: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</pre></table></code></div></div><p>restStorageProviders에 포함돼 있는 <a href="https://pkg.go.dev/k8s.io/kubernetes/pkg/controlplane#RESTStorageProvider">RESTStorageProviders</a> 를 통해 해당 API Group에 대한 <a href="https://pkg.go.dev/k8s.io/apiserver/pkg/server#APIGroupInfo">APIGroupInfo</a> 를 빌드하고 모아 <em>Line:30</em>의 <code class="language-plaintext highlighter-rouge">InstallAPIGroups(apiGroupInfo...)</code>를 호출하면서 인자로 전달한다.</p><dl><dt>RESTStorage<dd>특정 리소스나 컬렉션의 정보를 반환하는 동작에 대한 method를 구현할 수 있으며 생성과 변경 및 삭제 전략을 포함하는 인터페이스. API server에 RESTful API로 등록할 리소스들은 이 인터페이스를 구현해야 한다.<dt>RESTStorageProviders<dd>RESTStorage를 위한 Factory type이다. <code class="language-plaintext highlighter-rouge">GroupName()</code> method로 <code class="language-plaintext highlighter-rouge">/apis/apps</code>, <code class="language-plaintext highlighter-rouge">/apis/cerificates.k8s.io</code>와 같은 형태의 groupName을 가져올 수 있고, <code class="language-plaintext highlighter-rouge">NewRESTStorage()</code> method로 해당 API Group 내의 RESTStorage를 포함하고 있는 정보인 <a href="https://pkg.go.dev/k8s.io/apiserver/pkg/server#APIGroupInfo">APIGroupInfo</a> 가져올 수 있다.<dt>APIGroupInfo<dd>해당 API Group에 대한 정보를 포함한다. Group 내의 리소스들에 대한 정보가 들어있는 VersionedResourcesStorageMap을 가지고 있다.</dl><h3 id="resource-handler"><span class="mr-2">Resource Handler</span><a href="#resource-handler" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p><em>InstallAPIGroups -&gt; installAPIResources -&gt; InstallREST -&gt; registerResourceHandler</em>까지 도달하면서 apiGroupInfo에 포함된 RESTStorage를 통해 해당 리소스가 지원하는 작업들을 Action으로 저장하고 리소스 경로(<em>e.g., /api/apiVersion/resource</em>)에서 표준 REST 동사(GET, PUT, POST 및 DELETE)로 처리될 수 있도록 한다. 예를 들어 create에 해당하는 Action operation은 POST, update에 해당하는 Action operation은 PUT이다.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="k">switch</span> <span class="n">action</span><span class="o">.</span><span class="n">Verb</span> <span class="p">{</span>
<span class="k">case</span> <span class="s">"GET"</span><span class="o">:</span> <span class="c">// Get a resource.</span>
   <span class="k">var</span> <span class="n">handler</span> <span class="n">restful</span><span class="o">.</span><span class="n">RouteFunction</span>
   <span class="k">if</span> <span class="n">isGetterWithOptions</span> <span class="p">{</span>
     <span class="n">handler</span> <span class="o">=</span> <span class="n">restfulGetResourceWithOptions</span><span class="p">(</span><span class="n">getterWithOptions</span><span class="p">,</span> <span class="n">reqScope</span><span class="p">,</span> <span class="n">isSubresource</span><span class="p">)</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
     <span class="n">handler</span> <span class="o">=</span> <span class="n">restfulGetResource</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">reqScope</span><span class="p">)</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="n">needOverride</span> <span class="p">{</span>
     <span class="c">// need change the reported verb</span>
     <span class="n">handler</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">InstrumentRouteFunc</span><span class="p">(</span><span class="n">verbOverrider</span><span class="o">.</span><span class="n">OverrideMetricsVerb</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">Verb</span><span class="p">),</span> <span class="n">group</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">subresource</span><span class="p">,</span> <span class="n">requestScope</span><span class="p">,</span> <span class="n">metrics</span><span class="o">.</span><span class="n">APIServerComponent</span><span class="p">,</span> <span class="n">deprecated</span><span class="p">,</span> <span class="n">removedRelease</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
     <span class="n">handler</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">InstrumentRouteFunc</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">Verb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">subresource</span><span class="p">,</span> <span class="n">requestScope</span><span class="p">,</span> <span class="n">metrics</span><span class="o">.</span><span class="n">APIServerComponent</span><span class="p">,</span> <span class="n">deprecated</span><span class="p">,</span> <span class="n">removedRelease</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
   <span class="p">}</span>
   <span class="n">handler</span> <span class="o">=</span> <span class="n">utilwarning</span><span class="o">.</span><span class="n">AddWarningsHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">warnings</span><span class="p">)</span>

   <span class="n">doc</span> <span class="o">:=</span> <span class="s">"read the specified "</span> <span class="o">+</span> <span class="n">kind</span>
   <span class="k">if</span> <span class="n">isSubresource</span> <span class="p">{</span>
     <span class="n">doc</span> <span class="o">=</span> <span class="s">"read "</span> <span class="o">+</span> <span class="n">subresource</span> <span class="o">+</span> <span class="s">" of the specified "</span> <span class="o">+</span> <span class="n">kind</span>
   <span class="p">}</span>
   <span class="n">route</span> <span class="o">:=</span> <span class="n">ws</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span><span class="o">.</span><span class="n">To</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span><span class="o">.</span>
     <span class="n">Doc</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span><span class="o">.</span>
     <span class="n">Param</span><span class="p">(</span><span class="n">ws</span><span class="o">.</span><span class="n">QueryParameter</span><span class="p">(</span><span class="s">"pretty"</span><span class="p">,</span> <span class="s">"If 'true', then the output is pretty printed."</span><span class="p">))</span><span class="o">.</span>
     <span class="n">Operation</span><span class="p">(</span><span class="s">"read"</span><span class="o">+</span><span class="n">namespaced</span><span class="o">+</span><span class="n">kind</span><span class="o">+</span><span class="n">strings</span><span class="o">.</span><span class="n">Title</span><span class="p">(</span><span class="n">subresource</span><span class="p">)</span><span class="o">+</span><span class="n">operationSuffix</span><span class="p">)</span><span class="o">.</span>
     <span class="n">Produces</span><span class="p">(</span><span class="nb">append</span><span class="p">(</span><span class="n">storageMeta</span><span class="o">.</span><span class="n">ProducesMIMETypes</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">Verb</span><span class="p">),</span> <span class="n">mediaTypes</span><span class="o">...</span><span class="p">)</span><span class="o">...</span><span class="p">)</span><span class="o">.</span>
     <span class="n">Returns</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">StatusOK</span><span class="p">,</span> <span class="s">"OK"</span><span class="p">,</span> <span class="n">producedObject</span><span class="p">)</span><span class="o">.</span>
     <span class="n">Writes</span><span class="p">(</span><span class="n">producedObject</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">isGetterWithOptions</span> <span class="p">{</span>
     <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">AddObjectParams</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">versionedGetOptions</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
       <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="no">nil</span><span class="p">,</span> <span class="n">err</span>
     <span class="p">}</span>
   <span class="p">}</span>
   <span class="n">addParams</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">action</span><span class="o">.</span><span class="n">Params</span><span class="p">)</span>
   <span class="n">routes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">routes</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
</pre></table></code></div></div><p>마지막으로 Action 배열을 차례로 순회하여 각 operation에 handler method를 추가하여 Route에 등록하고, 생성된 Route를 WebService에 등록한다. 모든 Route를 등록한 WebService는 최종적으로 GoRestfulContainer에 등록되어 라우팅된다. 이 작업은 앞서 언급했던 go-restful design pattern과 완벽하게 일치한다.</p><dl><dt>Container<dd>여기서는 APIServerHandlers에 포함된 GoRestfulContainer를 말한다. HTTP 요청을 디스패치하기 위한 WebService 및 <a href="https://pkg.go.dev/net/http#ServeMux">http.ServeMux</a> 컬렉션을 가지고 있다. 요청은 <a href="https://pkg.go.dev/github.com/emicklei/go-restful@v2.9.5+incompatible#RouteSelector">RouteSelector</a> 를 사용해 WebServices의 경로에 추가로 디스패치된다.<dt>ServeMux<dd>HTTP 요청 Multiplexer이다. 각 수신 요청의 URL을 등록된 패턴의 목록과 일치시켜 URL과 가장 근접한 패턴에 대한 Handler를 호출한다.<dt>RouteSelector<dd>HTTP 요청이 주어지면 가장 일치하는 최적의 path를 찾는다. 선택적으로 PathProcessor 인터페이스를 구현하여 path가 선택된 후 path parameter도 추출할 수 있다.<dt>WebService<dd>Route 컬렉션을 가지고 있다.<dt>Route<dd>HTTP method + URL Path, Comsumers의 조합을 <a href="https://pkg.go.dev/github.com/emicklei/go-restful@v2.9.5+incompatible#RouteFunction">RouteFunction</a> 에 바인딩한다.<dt>RouteFunction<dd>Route에 바인딩할 수 있는 function의 signature를 선언한다.</dl><h3 id="execution-the-final-run-method"><span class="mr-2">Execution the final RUN method</span><a href="#execution-the-final-run-method" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>이렇게 server는 <code class="language-plaintext highlighter-rouge">CreateServerChain()</code> method를 통해 생성된다. 이제 다시 처음으로 돌아가 <code class="language-plaintext highlighter-rouge">NewAPIServerCommand()</code> method 내부에서 실행되는 <code class="language-plaintext highlighter-rouge">Run()</code> method를 보자.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="n">Run</span><span class="p">(</span><span class="n">completeOptions</span> <span class="n">completedServerRunOptions</span><span class="p">,</span> <span class="n">stopCh</span> <span class="o">&lt;-</span><span class="k">chan</span> <span class="k">struct</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="c">// ...</span>

  <span class="n">server</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">CreateServerChain</span><span class="p">(</span><span class="n">completeOptions</span><span class="p">,</span> <span class="n">stopCh</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">err</span>
  <span class="p">}</span>

  <span class="n">prepared</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">server</span><span class="o">.</span><span class="n">PrepareRun</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">err</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">prepared</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">stopCh</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Server를 시작하기 전에 <code class="language-plaintext highlighter-rouge">PrepareRun()</code> method에서 <code class="language-plaintext highlighter-rouge">/healthz</code> path 등록을 완료하고 Kubernetes API의 모든 세부 정보 및 사양을 포함한 OpenAPI 라우팅 등록 또한 완료한다. 이후 preparedGenericAPIServer의 <code class="language-plaintext highlighter-rouge">Run()</code> method를 호출해 <code class="language-plaintext highlighter-rouge">NonBlockingRun()</code> method를 통해 secure HTTP server를 시작한다.</p><h2 id="watch-server-creation"><span class="mr-2">Watch Server Creation</span><a href="#watch-server-creation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Watch Server가 생성되는 과정을 정리하고 마무리해야겠다. registerResourceHandler에서 <code class="language-plaintext highlighter-rouge">action.Verb</code>가 “LIST”일 경우를 살펴보자.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">case</span> <span class="s">"LIST"</span><span class="o">:</span> <span class="c">// List all resources of a kind.</span>
  <span class="c">// ...</span>
  <span class="n">handler</span> <span class="o">:=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">InstrumentRouteFunc</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">Verb</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">subresource</span><span class="p">,</span> <span class="n">requestScope</span><span class="p">,</span> <span class="n">metrics</span><span class="o">.</span><span class="n">APIServerComponent</span><span class="p">,</span> <span class="n">deprecated</span><span class="p">,</span> <span class="n">removedRelease</span><span class="p">,</span> <span class="n">restfulListResource</span><span class="p">(</span><span class="n">lister</span><span class="p">,</span> <span class="n">watcher</span><span class="p">,</span> <span class="n">reqScope</span><span class="p">,</span> <span class="no">false</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">minRequestTimeout</span><span class="p">))</span>
  <span class="n">handler</span> <span class="o">=</span> <span class="n">utilwarning</span><span class="o">.</span><span class="n">AddWarningsHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">warnings</span><span class="p">)</span>
  <span class="n">route</span> <span class="o">:=</span> <span class="n">ws</span><span class="o">.</span><span class="n">GET</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span><span class="o">.</span><span class="n">To</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span><span class="o">.</span>
    <span class="n">Doc</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span><span class="o">.</span>
    <span class="n">Param</span><span class="p">(</span><span class="n">ws</span><span class="o">.</span><span class="n">QueryParameter</span><span class="p">(</span><span class="s">"pretty"</span><span class="p">,</span> <span class="s">"If 'true', then the output is pretty printed."</span><span class="p">))</span><span class="o">.</span>
    <span class="n">Operation</span><span class="p">(</span><span class="s">"list"</span><span class="o">+</span><span class="n">namespaced</span><span class="o">+</span><span class="n">kind</span><span class="o">+</span><span class="n">strings</span><span class="o">.</span><span class="n">Title</span><span class="p">(</span><span class="n">subresource</span><span class="p">)</span><span class="o">+</span><span class="n">operationSuffix</span><span class="p">)</span><span class="o">.</span>
    <span class="n">Produces</span><span class="p">(</span><span class="nb">append</span><span class="p">(</span><span class="n">storageMeta</span><span class="o">.</span><span class="n">ProducesMIMETypes</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">Verb</span><span class="p">),</span> <span class="n">allMediaTypes</span><span class="o">...</span><span class="p">)</span><span class="o">...</span><span class="p">)</span><span class="o">.</span>
    <span class="n">Returns</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">StatusOK</span><span class="p">,</span> <span class="s">"OK"</span><span class="p">,</span> <span class="n">versionedList</span><span class="p">)</span><span class="o">.</span>
    <span class="n">Writes</span><span class="p">(</span><span class="n">versionedList</span><span class="p">)</span>
  <span class="c">// ...</span>
  <span class="n">routes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">routes</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
</pre></table></code></div></div><p>Handler를 생성할 때 <code class="language-plaintext highlighter-rouge">restfulListResource()</code> 함수를 호출하면서 watcher를 넘겨주는 것을 볼 수 있다. 이 watcher는 <code class="language-plaintext highlighter-rouge">watcher, isWatcher := storage.(rest.Watcher)</code>에서 가져오는 것으로 해당 리소스의 RESTStorage에 이미 등록된 Watcher 구현체이다. RESTStorage는 곧 ETCDStorage이며 ETCDStorage 내부엔 Store가 존재한다. 이 Store는 <a href="https://pkg.go.dev/k8s.io/apiserver/pkg/registry/generic/registry#DryRunnableStorage">DryRunnableStorage</a> 를 가지고 있으며, DryRunnableStorage 또한 wrapping하기 위한 <code class="language-plaintext highlighter-rouge">storage.Interface</code>를 가지고 있는데 여기엔 <a href="https://pkg.go.dev/k8s.io/apiserver/pkg/registry/generic#RESTOptions">RESTOptions</a> 의 <a href="https://pkg.go.dev/k8s.io/apiserver/pkg/registry/generic#StorageDecorator">Decorator</a>에 등록된 함수가 사용돼 <a href="https://pkg.go.dev/k8s.io/apiserver/pkg/registry/generic#UndecoratedStorage">UndecoratedStorage</a> 또는 <a href="https://pkg.go.dev/k8s.io/apiserver/pkg/registry/generic/registry#StorageWithCacher">Cacher</a> 가 할당되게 된다.</p><p>watchCache 기능이 필요한 리소스라면 Cacher가 할당되며 <code class="language-plaintext highlighter-rouge">storage.(rest.Watcher)</code>를 따라가다보면 결국 위의 <code class="language-plaintext highlighter-rouge">watcher</code>는 Cacher의 <code class="language-plaintext highlighter-rouge">Watch()</code>에서 반환해주는 CacheWatcher가 된다.</p><p><em>restfulListResource -&gt; ListResource -&gt; serveWatch</em> 순으로 호출되면서 리소스에 알맞는 watch 응답을 성공적으로 제공할 수 있게 되는 것이다.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="n">serveWatch</span><span class="p">(</span><span class="n">watcher</span> <span class="n">watch</span><span class="o">.</span><span class="n">Interface</span><span class="p">,</span> <span class="n">scope</span> <span class="o">*</span><span class="n">RequestScope</span><span class="p">,</span> <span class="n">mediaTypeOptions</span> <span class="n">negotiation</span><span class="o">.</span><span class="n">MediaTypeOptions</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">,</span> <span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">timeout</span> <span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">defer</span> <span class="n">watcher</span><span class="o">.</span><span class="n">Stop</span><span class="p">()</span>

  <span class="c">// ...</span>

  <span class="n">server</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">WatchServer</span><span class="p">{</span>
    <span class="n">Watching</span><span class="o">:</span> <span class="n">watcher</span><span class="p">,</span>
    <span class="n">Scope</span><span class="o">:</span>    <span class="n">scope</span><span class="p">,</span>

    <span class="n">UseTextFraming</span><span class="o">:</span>  <span class="n">useTextFraming</span><span class="p">,</span>
    <span class="n">MediaType</span><span class="o">:</span>       <span class="n">mediaType</span><span class="p">,</span>
    <span class="n">Framer</span><span class="o">:</span>          <span class="n">framer</span><span class="p">,</span>
    <span class="n">Encoder</span><span class="o">:</span>         <span class="n">encoder</span><span class="p">,</span>
    <span class="n">EmbeddedEncoder</span><span class="o">:</span> <span class="n">embeddedEncoder</span><span class="p">,</span>

    <span class="n">Fixup</span><span class="o">:</span> <span class="k">func</span><span class="p">(</span><span class="n">obj</span> <span class="n">runtime</span><span class="o">.</span><span class="n">Object</span><span class="p">)</span> <span class="n">runtime</span><span class="o">.</span><span class="n">Object</span> <span class="p">{</span>
      <span class="n">result</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">transformObject</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">mediaTypeOptions</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">utilruntime</span><span class="o">.</span><span class="n">HandleError</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"failed to transform object %v: %v"</span><span class="p">,</span> <span class="n">reflect</span><span class="o">.</span><span class="n">TypeOf</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">obj</span>
      <span class="p">}</span>
      <span class="c">// When we are transformed to a table, use the table options as the state for whether we</span>
      <span class="c">// should print headers - on watch, we only want to print table headers on the first object</span>
      <span class="c">// and omit them on subsequent events.</span>
      <span class="k">if</span> <span class="n">tableOptions</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">options</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">metav1</span><span class="o">.</span><span class="n">TableOptions</span><span class="p">);</span> <span class="n">ok</span> <span class="p">{</span>
        <span class="n">tableOptions</span><span class="o">.</span><span class="n">NoHeaders</span> <span class="o">=</span> <span class="no">true</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="n">result</span>
    <span class="p">},</span>

    <span class="n">TimeoutFactory</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">realTimeoutFactory</span><span class="p">{</span><span class="n">timeout</span><span class="p">},</span>
  <span class="p">}</span>

  <span class="n">server</span><span class="o">.</span><span class="n">ServeHTTP</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">serveWatch()</code>에서 WatchServer는 전달된 watcher를 가지고 생성되며 <a href="http://blog.wqlee.com/posts/what-is-a-kubernetes-watch-event/">Kubernetes의 Watch event는 어떻게 동작하는가</a> 의 마지막쯔음에 보았던 ServeHTTP method가 실행되면서 내부 로직을 통해 일련의 인코딩된 이벤트를 클라이언트에게 제공하게 된다.</p><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Kubernetes API server는 go-restful design pattern을 따르며 특정 리소스의 RESTStorage에 구현된 watcher를 통해 클라이언트에게 watch event에 대한 응답을 제공한다.</p><p>생략을 나름대로 최대한 했음에도 불구하고 굉장히 정교하고 복잡한 핵심 코어인지라 API server 코드 분석이 매우 길어졌다. 부족한 부분들이 아쉽기도 한데 이쯤 정리하는 선에서 일단은 만족하기로 했다. 이 포스팅과 관련해 추가적인 수정 사항이나 보충할 내용이 생긴다면 그 때 업데이트할 예정이다.</p><p>이번 분석을 통해 API server에 요청된 watch event가 어떠한 방식으로 Watch Server에 전달이 되는지 알게 되었다. 수많은 클라이언트가 API server와 watch event를 위해 connection을 맺고 있다면 어느 정도 부하가 생길 수도 있다고 다들 이야기를 하고 있으며 공감도 된다. 더 효율적인 접근을 위해 Kubernetes에서는 Informer를 제공해주고 있다고 하는데 다음으로는 Informer란 어떤 것인지, 그리고 어떠한 아키텍처를 통해 위와 같은 문제를 해결했는지 정리해보자.</p><div style="text-align: center; font-weight: bold; margin-top: 100px; margin-bottom: 50px">끝.</div><hr /><div class="footnotes" role="doc-endnotes"><ol><li id="fn:1" role="doc-endnote"><p>https://github.com/spf13/cobra <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:2" role="doc-endnote"><p>https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/ <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p></ol></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kubernetes/'>kubernetes</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >kubernetes</a> <a href="/tags/watch/" class="post-tag no-text-decoration" >watch</a> <a href="/tags/event/" class="post-tag no-text-decoration" >event</a> <a href="/tags/apiserver/" class="post-tag no-text-decoration" >apiserver</a> <a href="/tags/gorestful/" class="post-tag no-text-decoration" >gorestful</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Watch+Server%EC%97%90+%EC%9A%94%EC%B2%AD%EC%9D%B4+%EB%8F%84%EB%8B%AC%ED%95%98%EA%B8%B0%EA%B9%8C%EC%A7%80%EC%9D%98+%EA%B3%BC%EC%A0%95+-+wq.lee&url=https%3A%2F%2Fblog.wqlee.com%2Fposts%2Fwhat-is-a-kubernetes-watch-event-2nd%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Watch+Server%EC%97%90+%EC%9A%94%EC%B2%AD%EC%9D%B4+%EB%8F%84%EB%8B%AC%ED%95%98%EA%B8%B0%EA%B9%8C%EC%A7%80%EC%9D%98+%EA%B3%BC%EC%A0%95+-+wq.lee&u=https%3A%2F%2Fblog.wqlee.com%2Fposts%2Fwhat-is-a-kubernetes-watch-event-2nd%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fblog.wqlee.com%2Fposts%2Fwhat-is-a-kubernetes-watch-event-2nd%2F&text=Watch+Server%EC%97%90+%EC%9A%94%EC%B2%AD%EC%9D%B4+%EB%8F%84%EB%8B%AC%ED%95%98%EA%B8%B0%EA%B9%8C%EC%A7%80%EC%9D%98+%EA%B3%BC%EC%A0%95+-+wq.lee" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fblog.wqlee.com%2Fposts%2Fwhat-is-a-kubernetes-watch-event-2nd%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/cgroups-and-kubernetes/">Control groups & Kubernetes</a><li><a href="/posts/what-is-a-kubernetes-watch-event-4rd/">Event란건 어쩌면 어려운게 아닐까</a><li><a href="/posts/scheduling-in-go-01/">Scheduling In Go I - OS Scheduler</a><li><a href="/posts/what-is-a-kubernetes-watch-event-3rd/">Informer의 구조</a><li><a href="/posts/what-is-a-kubernetes-watch-event-2nd/">Watch Server에 요청이 도달하기까지의 과정</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/event/">event</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/watch/">watch</a> <a class="post-tag" href="/tags/os/">os</a> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/apiserver/">apiserver</a> <a class="post-tag" href="/tags/go/">go</a> <a class="post-tag" href="/tags/gorestful/">gorestful</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/scheduler/">scheduler</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/what-is-a-kubernetes-watch-event-3rd/"><div class="card-body"> <em class="timeago small" data-ts="1641649500" > 2022-01-08 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Informer의 구조</h3><div class="text-muted small"><p> 일전에 정리했던 내용과 같이 클라이언트가 API server에 Watch event를 요청할 때 streaming HTTP connection을 맺어 해당 리소스의 변경에 대한 이벤트를 전달받곤 했다. 이러한 변경 감지가 필요할 때마다 API server에 접근해야하는건 Kubernetes 시스템에 부하를 줄 수도 있다. 게다가 여러 클라이언트, 컨트...</p></div></div></a></div><div class="card"> <a href="/posts/basic-etcd/"><div class="card-body"> <em class="timeago small" data-ts="1642600800" > 2022-01-19 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Basic ETCD</h3><div class="text-muted small"><p> Highly Available Fully Replicated Strong consistency model Scalable watch mechanism Concurrency control primitives Distributed Key/Value store Distributed consensus is a fancy way to e...</p></div></div></a></div><div class="card"> <a href="/posts/what-is-a-kubernetes-watch-event-4rd/"><div class="card-body"> <em class="timeago small" data-ts="1643454000" > 2022-01-29 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Event란건 어쩌면 어려운게 아닐까</h3><div class="text-muted small"><p> Kubernetes Architecture Kubernetes는 microservice 기반의 아키텍처가 적용되어 있다. Control Plane, Worker Node의 컴포넌트들은 개별 서비스로 구현된다. 특히 Control Plane은 Event와 함께 느슨하게 결합된 구성 요소의 원칙을 많이 접목시켜 사용하고 있다. 이러한 아키텍처의 주요 이...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/what-is-a-kubernetes-watch-event/" class="btn btn-outline-primary" prompt="Older"><p>Kubernetes의 Watch event는 어떻게 동작하는가</p></a> <a href="/posts/what-is-a-kubernetes-watch-event-3rd/" class="btn btn-outline-primary" prompt="Newer"><p>Informer의 구조</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://www.linkedin.com/in/wq-lee">Wongyu Lee</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/event/">event</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/watch/">watch</a> <a class="post-tag" href="/tags/os/">os</a> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/apiserver/">apiserver</a> <a class="post-tag" href="/tags/go/">go</a> <a class="post-tag" href="/tags/gorestful/">gorestful</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/scheduler/">scheduler</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-4PS0JXVL1J"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-4PS0JXVL1J'); }); </script>
